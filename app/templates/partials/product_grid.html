{% for product in products %}
<div
    class="flex flex-col group obsidian-glass p-2 rounded-2xl vault-card-outline transition-all duration-150 hover:scale-[1.02] hover:border-primary/50 shadow-lg">
    <!-- Modal Trigger Area (Image) -->
    <div class="relative aspect-[3/4] rounded-xl overflow-hidden cursor-pointer" hx-get="/product/{{ product.id }}"
        hx-target="#modal-container" hx-swap="innerHTML">
        <img alt="{{ product.title }}"
            class="w-full h-full object-cover rounded-xl transition-transform duration-200 group-hover:scale-110"
            src="{{ product.image }}{% if '?' in product.image %}&{% else %}?{% endif %}width=400" loading="lazy" />
        <div
            class="absolute top-3 left-3 px-2 py-1 bg-black/70 backdrop-blur-md rounded-md text-[8px] font-black text-white border border-white/10 uppercase tracking-widest">
            {{ product.badge }}
        </div>
        {% if product.status == 'Sync' %}
        <div
            class="absolute top-12 left-3 px-2 py-1 bg-black/70 backdrop-blur-md rounded-md text-[8px] font-bold text-white border border-white/10 flex items-center gap-1 shadow-sm">
            <span class="material-symbols-outlined text-[10px] text-green-400">check_circle</span>
            <span>In Stock</span>
        </div>
        {% endif %}
    </div>

    <!-- Info & Action Area -->
    <div class="mt-4 px-1 space-y-3">
        <div hx-get="/product/{{ product.id }}" hx-target="#modal-container" hx-swap="innerHTML" class="cursor-pointer">
            <div class="flex items-center justify-between">
                <h4 class="text-xs font-bold truncate pr-2 text-white/90">{{ product.title }}</h4>
                <div class="flex items-center gap-1">
                    <span
                        class="w-1 h-1 rounded-full {{ 'bg-green-500' if product.status == 'Sync' else 'bg-primary' }}"></span>
                    <span class="text-[7px] text-gray-500 uppercase font-black">{{ product.status }}</span>
                </div>
            </div>
            <p class="text-[9px] text-gray-500 font-medium tracking-tight">{{ product.rarity }} • {{ product.set }}</p>
        </div>

        <div class="flex items-center justify-between pt-1">
            <span class="text-sm font-black text-primary">¥{{ "{:,.0f}".format(product.price) }}</span>

            <!-- Quick Add Controls -->
            <div class="flex items-center gap-2">
                <div class="flex items-center bg-white/5 border border-white/10 rounded-full p-0.5 h-8">
                    <button onclick="updateQty('grid-qty-{{ product.safe_id }}', -1); event.stopPropagation();"
                        class="w-6 h-6 flex items-center justify-center hover:bg-white/10 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-[12px]">remove</span>
                    </button>
                    <span id="grid-qty-{{ product.safe_id }}" class="w-6 text-center text-[10px] font-black">1</span>
                    <button onclick="updateQty('grid-qty-{{ product.safe_id }}', 1); event.stopPropagation();"
                        class="w-6 h-6 flex items-center justify-center hover:bg-white/10 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-[12px]">add</span>
                    </button>
                </div>

                <button
                    onclick="handleCartAction('{{ product.variant_id }}', 'add', event, 'grid-qty-{{ product.safe_id }}')"
                    class="w-8 h-8 rounded-full bg-primary/10 border border-primary/20 text-primary flex items-center justify-center hover:bg-primary/20 active:scale-90 transition-all">
                    <span class="material-symbols-outlined text-sm">add_shopping_cart</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Pagination Controls -->
{% if total_pages > 1 %}
<div class="col-span-full flex items-center justify-center gap-4 mt-12 py-6 border-t border-white/5">
    <button
        class="flex items-center gap-2 px-6 py-2 rounded-full bg-white/5 border border-white/10 text-xs font-bold uppercase tracking-widest transition-all {{ 'opacity-30 cursor-not-allowed' if current_page <= 1 else 'hover:bg-white/10 hover:border-primary/50 text-white' }}"
        {% if current_page> 1 %}
        hx-get="/filter?page={{ current_page - 1 }}"
        hx-target="#product-grid"
        hx-include="#search-input, #rarity-input, #price-slider, #collection-input"
        {% else %}
        disabled
        {% endif %}>
        <span class="material-symbols-outlined text-sm">chevron_left</span>
        Prev
    </button>

    <div class="flex items-center gap-2">
        <span class="text-[10px] font-black text-primary uppercase tracking-widest">Page</span>
        <span
            class="w-8 h-8 rounded-full bg-primary/10 border border-primary/20 flex items-center justify-center text-xs font-black text-white shadow-[0_0_15px_rgba(244,37,209,0.3)]">
            {{ current_page }}
        </span>
        <span class="text-[10px] font-black text-gray-600 uppercase tracking-widest">of {{ total_pages }}</span>
    </div>

    <button
        class="flex items-center gap-2 px-6 py-2 rounded-full bg-white/5 border border-white/10 text-xs font-bold uppercase tracking-widest transition-all {{ 'opacity-30 cursor-not-allowed' if current_page >= total_pages else 'hover:bg-white/10 hover:border-primary/50 text-white' }}"
        {% if current_page < total_pages %} hx-get="/filter?page={{ current_page + 1 }}" hx-target="#product-grid"
        hx-include="#search-input, #rarity-input, #price-slider, #collection-input" {% else %} disabled {% endif %}>
        Next
        <span class="material-symbols-outlined text-sm">chevron_right</span>
    </button>
</div>
{% endif %}

{% if not products %}
<div class="col-span-full text-center py-12">
    <span class="material-symbols-outlined text-gray-600 text-4xl mb-2">search_off</span>
    <p class="text-gray-400 text-sm">No cards found in the vault.</p>
</div>
{% endif %}

{% if request.headers.get('HX-Request') and (collections or svr_active_rarity) %}
{% set oob = true %}
{% include "partials/collection_filters.html" %}
{% include "partials/rarity_filters.html" %}
{% endif %}