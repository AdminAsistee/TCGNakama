<!-- Card Count Header -->
<div class="flex items-center justify-between mb-4 px-1 col-span-full">
    <h3 class="text-sm font-bold uppercase tracking-[0.25em] text-gray-400">All Cards</h3>
    <span class="text-[10px] font-black text-gray-600 uppercase tracking-wider">{{ products|length }} in vault</span>
</div>

{% for product in products %}
<div
    class="flex flex-col bg-surface rounded-xl border border-white/[0.1] overflow-hidden transition-all duration-150 hover:scale-[1.02] hover:border-primary/30 shadow-lg">
    <!-- Card Image -->
    <a href="/card/{{ product.id }}" class="relative block overflow-hidden rounded-t-xl" style="aspect-ratio: 5/7;">
        <img alt="{{ product.title }}"
            class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-110"
            src="{{ product.image }}{% if '?' in product.image %}&{% else %}?{% endif %}width=400" loading="lazy" />
        <!-- Rarity/Type Badge -->
        <div
            class="absolute top-2.5 left-2.5 px-2 py-0.5 bg-black/70 backdrop-blur-md rounded-md text-[8px] font-black text-white/90 border border-white/10 uppercase tracking-widest">
            {{ product.badge }}
        </div>
        <!-- Stock Status -->
        {% if product.totalInventory > 0 %}
        <div
            class="absolute bottom-2.5 left-2.5 px-2 py-0.5 bg-black/70 backdrop-blur-md rounded-md text-[8px] font-bold text-white border border-white/10 flex items-center gap-1">
            <span class="w-1.5 h-1.5 bg-neon-green rounded-full"></span>
            <span>In Stock</span>
        </div>
        {% elif product.totalInventory == 0 %}
        <div class="absolute inset-0 bg-black/50 backdrop-blur-[1px] flex items-center justify-center">
            <span
                class="text-sm font-black text-red-400 uppercase tracking-widest bg-black/70 px-4 py-2 rounded-lg border border-red-500/30">Sold
                Out</span>
        </div>
        {% endif %}
    </a>

    <!-- Info & Action Area -->
    <div class="px-3 py-2.5 flex flex-col flex-1 gap-1.5">
        <a href="/card/{{ product.id }}" class="cursor-pointer flex-1 block min-w-0">
            <h4 class="text-[11px] md:text-xs font-bold text-white/90 leading-snug line-clamp-2">{{ product.title }}
            </h4>
            <p class="text-[9px] md:text-[10px] text-gray-500 mt-0.5 truncate">{{ product.set }}</p>
        </a>

        <div class="flex items-center justify-between pt-1.5 border-t border-white/5">
            <p class="text-sm font-black text-primary">Â¥{{ "{:,}".format(product.price|int) }}</p>
            {% if product.totalInventory > 0 %}
            <button onclick="handleCartAction('{{ product.variant_id }}', 'add', event)"
                class="min-h-[44px] px-4 bg-primary hover:bg-primary/80 text-background-dark text-[10px] font-black rounded-lg transition-colors flex items-center gap-1.5 shadow-sm uppercase tracking-wider active:scale-95">
                <span class="material-symbols-outlined text-base">add_shopping_cart</span>
                <span>Add</span>
            </button>
            {% else %}
            <span
                class="min-h-[44px] px-3 bg-gray-700/30 text-red-400/70 text-[9px] font-black rounded-lg flex items-center gap-1 uppercase tracking-wider border border-red-500/10">
                <span class="material-symbols-outlined text-xs">block</span>
                Sold
            </span>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="col-span-full flex justify-center items-center gap-2 mt-8">
    {% if current_page > 1 %}
    <button hx-get="/filter?page={{ current_page - 1 }}" hx-target="#product-grid" hx-swap="innerHTML"
        class="px-3 py-1 bg-white/5 hover:bg-white/10 text-white text-xs rounded border border-white/10 transition-colors">
        Previous
    </button>
    {% endif %}

    <span class="text-xs text-gray-400">Page {{ current_page }} of {{ total_pages }}</span>

    {% if current_page < total_pages %} <button hx-get="/filter?page={{ current_page + 1 }}" hx-target="#product-grid"
        hx-swap="innerHTML"
        class="px-3 py-1 bg-white/5 hover:bg-white/10 text-white text-xs rounded border border-white/10 transition-colors">
        Next
        </button>
        {% endif %}
</div>
{% endif %}

<!-- No Results Message -->
{% if products|length == 0 %}
<div class="col-span-full text-center py-12">
    <span class="material-symbols-outlined text-6xl text-gray-600">search_off</span>
    <p class="text-gray-400 mt-4">No cards found matching your filters.</p>
    <button onclick="resetFilters()"
        class="mt-4 px-4 py-2 bg-primary hover:bg-primary/80 text-white text-sm font-bold rounded-md transition-colors">
        Reset Filters
    </button>
</div>
{% endif %}

{% if request.headers.get('HX-Request') and (collections or svr_active_rarity or svr_active_condition) %}
{% set oob = true %}
{% include "partials/collection_filters.html" %}
{% include "partials/rarity_filters.html" %}
{% include "partials/condition_filters.html" %}
{% endif %}