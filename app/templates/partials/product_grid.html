<!-- Card Count Header -->
<div class="flex items-center justify-between mb-6 px-1 col-span-full">
    <h3 class="text-sm font-bold uppercase tracking-[0.25em] text-gray-400">All Cards</h3>
    <span class="text-[10px] font-black text-gray-600 uppercase tracking-wider">{{ products|length }} in vault</span>
</div>

{% for product in products %}
<div
    class="flex flex-col group bg-surface rounded-xl border border-vault-border overflow-hidden transition-all duration-150 hover:scale-[1.02] hover:border-primary/30 shadow-lg">
    <!-- Modal Trigger Area (Image) -->
    <div class="relative aspect-[3/4] overflow-hidden cursor-pointer" hx-get="/product/{{ product.id }}"
        hx-target="#modal-container" hx-swap="innerHTML">
        <img alt="{{ product.title }}"
            class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-110"
            src="{{ product.image }}{% if '?' in product.image %}&{% else %}?{% endif %}width=400" loading="lazy" />
        <div
            class="absolute top-3 left-3 px-2 py-1 bg-black/70 backdrop-blur-md rounded-md text-[8px] font-black text-white border border-white/10 uppercase tracking-widest">
            {{ product.badge }}
        </div>
        {% if product.status == 'Sync' %}
        <div
            class="absolute top-12 left-3 px-2 py-1 bg-black/70 backdrop-blur-md rounded-md text-[8px] font-bold text-white border border-white/10 flex items-center gap-1 shadow-sm">
            <span class="material-symbols-outlined text-[10px] text-neon-green">check_circle</span>
            <span>In Stock</span>
        </div>
        {% endif %}
    </div>

    <!-- Info & Action Area -->
    <div class="mt-3 px-3 pb-4 space-y-2 flex flex-col flex-1">
        <div hx-get="/product/{{ product.id }}" hx-target="#modal-container" hx-swap="innerHTML"
            class="cursor-pointer flex-1">
            <div class="flex items-start justify-between gap-1">
                <h4 class="text-xs font-bold text-white/90 line-clamp-2 leading-snug">{{ product.title }}</h4>
                <div class="flex items-center gap-1 shrink-0 mt-0.5">
                    <span
                        class="w-1 h-1 rounded-full {{ 'bg-neon-green' if product.status == 'Sync' else 'bg-primary' }}"></span>
                    <span
                        class="text-[8px] font-black uppercase tracking-wider {{ 'text-neon-green' if product.status == 'Sync' else 'text-primary' }}">{{
                        product.status }}</span>
                </div>
            </div>
            <p class="text-[10px] text-gray-400 mt-1">{{ product.set }}</p>
        </div>

        <div class="flex items-center justify-between pt-2 border-t border-white/5">
            <p class="text-sm font-black text-primary">Â¥{{ "{:,}".format(product.price|int) }}</p>
            <button onclick="handleCartAction('{{ product.variant_id }}', 'add', event)"
                class="h-9 px-4 bg-primary hover:bg-primary/80 text-background-dark text-[10px] font-black rounded-lg transition-colors flex items-center gap-1.5 shadow-sm uppercase tracking-wider">
                <span class="material-symbols-outlined text-base">add_shopping_cart</span>
                <span>Add</span>
            </button>
        </div>
    </div>
</div>
{% endfor %}

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="col-span-full flex justify-center items-center gap-2 mt-8">
    {% if current_page > 1 %}
    <button hx-get="/filter?page={{ current_page - 1 }}" hx-target="#product-grid" hx-swap="innerHTML"
        class="px-3 py-1 bg-white/5 hover:bg-white/10 text-white text-xs rounded border border-white/10 transition-colors">
        Previous
    </button>
    {% endif %}

    <span class="text-xs text-gray-400">Page {{ current_page }} of {{ total_pages }}</span>

    {% if current_page < total_pages %} <button hx-get="/filter?page={{ current_page + 1 }}" hx-target="#product-grid"
        hx-swap="innerHTML"
        class="px-3 py-1 bg-white/5 hover:bg-white/10 text-white text-xs rounded border border-white/10 transition-colors">
        Next
        </button>
        {% endif %}
</div>
{% endif %}

<!-- No Results Message -->
{% if products|length == 0 %}
<div class="col-span-full text-center py-12">
    <span class="material-symbols-outlined text-6xl text-gray-600">search_off</span>
    <p class="text-gray-400 mt-4">No cards found matching your filters.</p>
    <button onclick="resetFilters()"
        class="mt-4 px-4 py-2 bg-primary hover:bg-primary/80 text-white text-sm font-bold rounded-md transition-colors">
        Reset Filters
    </button>
</div>
{% endif %}

{% if request.headers.get('HX-Request') and (collections or svr_active_rarity or svr_active_condition) %}
{% set oob = true %}
{% include "partials/collection_filters.html" %}
{% include "partials/rarity_filters.html" %}
{% include "partials/condition_filters.html" %}
{% endif %}