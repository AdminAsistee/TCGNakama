<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Add New Card | Collector Intelligence</title>
    <!-- Common Styles -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;family=Noto+Sans:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#257bf4",
                        "background-light": "#f5f7f8",
                        "background-dark": "#0A0A0A",
                        "surface-dark": "#121212",
                        "glass": "rgba(255, 255, 255, 0.03)",
                        "glass-border": "rgba(255, 255, 255, 0.1)",
                        "neon-blue": "#00f0ff",
                        "neon-purple": "#bc13fe",
                        "neon-green": "#0bda5e",
                        "neon-gold": "#ffd700",
                        "danger-red": "#ff2a6d",
                        "obsidian-black": "#000000",
                        "teal-accent": "#00f2ea",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                },
            },
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .holo-glow {
            box-shadow: 0 0 20px rgba(37, 123, 244, 0.3), 0 0 40px rgba(0, 240, 255, 0.1);
            background: linear-gradient(135deg, #257bf4 0%, #bc13fe 50%, #00f2ea 100%);
            background-size: 200% 200%;
        }

        /* Hide spin buttons for number input */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: none;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-white selection:bg-primary selection:text-white pb-24">
    <header class="sticky top-0 z-50 glass-panel border-b border-glass-border">
        <div class="flex items-center p-4 justify-between h-16">
            <button onclick="window.location.href='/admin'"
                class="text-white/80 hover:text-white transition-colors flex items-center justify-center rounded-lg active:bg-white/10 p-2 -ml-2">
                <span class="material-symbols-outlined text-[28px]">arrow_back</span>
            </button>
            <h1
                class="text-lg font-bold tracking-[0.15em] text-center uppercase text-transparent bg-clip-text bg-gradient-to-r from-white via-blue-100 to-white drop-shadow-[0_0_10px_rgba(255,255,255,0.2)]">
                {% if edit_mode %}Edit Card{% else %}Add New Card{% endif %}
            </h1>
            <div class="w-10"></div> <!-- Spacer for balance -->
        </div>
    </header>

    <main class="flex flex-col gap-6 p-4 max-w-4xl mx-auto">
        {% if error %}
        <div class="p-3 bg-red-500/10 border border-red-500/50 rounded-xl flex items-start gap-3">
            <span class="material-symbols-outlined text-red-500 mt-0.5">error</span>
            <p class="text-xs text-red-200">{{ error }}</p>
        </div>
        {% endif %}

        <!-- Loading Overlay -->
        <div id="loading-overlay"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
            <div
                class="glass-panel rounded-2xl p-8 border border-white/10 flex flex-col items-center gap-6 max-w-sm mx-4">
                <div class="relative w-20 h-20">
                    <div class="absolute inset-0 border-4 border-primary/20 rounded-full"></div>
                    <div
                        class="absolute inset-0 border-4 border-transparent border-t-primary rounded-full animate-spin">
                    </div>
                </div>
                <div class="text-center space-y-2">
                    <h3 class="text-lg font-bold text-white">{% if edit_mode %}Updating{% else %}Adding{% endif %}
                        Card...</h3>
                    <p class="text-sm text-white/60">Please wait while we process your card</p>
                </div>
            </div>
        </div>

        <!-- Duplicate Card Detection Modal -->
        <div id="duplicate-modal"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
            <div class="glass-panel rounded-2xl p-8 border border-white/10 flex flex-col gap-6 max-w-md mx-4">
                <div class="flex items-start gap-4">
                    <span class="material-symbols-outlined text-4xl text-yellow-400">warning</span>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white mb-2">Duplicate Card Detected</h3>
                        <p class="text-sm text-white/60 mb-4">A card with the same name and rarity already exists:</p>
                        <p id="duplicate-card-name"
                            class="text-sm text-white font-medium bg-white/5 p-3 rounded-lg border border-white/10"></p>
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    <button type="button" onclick="editExistingCard()"
                        class="w-full py-3 rounded-xl bg-gradient-to-r from-neon-purple to-primary text-white font-bold text-sm transition-all hover:shadow-lg hover:shadow-primary/50">
                        Edit Existing Card
                    </button>
                    <button type="button" onclick="closeDuplicateModal()"
                        class="w-full py-3 rounded-xl bg-white/5 border border-white/10 text-white font-bold text-sm transition-all hover:bg-white/10">
                        Cancel
                    </button>
                    <button type="button" onclick="window.location.href='/admin'"
                        class="w-full py-3 rounded-xl bg-white/5 border border-white/10 text-white/60 font-bold text-sm transition-all hover:bg-white/10 hover:text-white">
                        Exit Form
                    </button>
                </div>
            </div>
        </div>

        <form action="{% if edit_mode %}/admin/update-card{% else %}/admin/add-card{% endif %}" method="POST"
            enctype="multipart/form-data" class="flex flex-col gap-8" onsubmit="return checkDuplicateAndSubmit(event)">
            {% if edit_mode %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <input type="hidden" name="variant_id" value="{{ product.variant_id }}">
            {% endif %}
            <!-- Asset Section -->
            <section class="glass-panel rounded-2xl p-6 border border-white/10">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-white/50">Card Assets <span
                            class="text-red-400">*</span></h2>
                    <span
                        class="text-[10px] text-neon-blue font-bold uppercase tracking-wider bg-neon-blue/10 px-2 py-0.5 rounded border border-neon-blue/20">Sources</span>
                </div>

                <p id="image-error" class="text-xs text-red-400 hidden mb-3">Please upload at least one image</p>

                <div class="space-y-6">
                    <!-- Image Previews Container -->
                    <div id="image-previews"
                        class="flex gap-3 overflow-x-auto pb-2 custom-scrollbar snap-x empty:hidden">
                        <!-- Previews will appear here -->
                    </div>

                    <!-- File Upload Input -->
                    <div class="flex flex-col gap-3">
                        <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Upload Local
                            Files</label>
                        <div class="relative group">
                            <input type="file" name="image_files" id="file-input" multiple accept="image/*"
                                class="hidden" onchange="handleFileSelect(this)">
                            <label for="file-input"
                                class="w-full flex items-center justify-center gap-3 bg-surface-dark border-2 border-dashed border-white/10 hover:border-primary/50 rounded-xl p-6 transition-all cursor-pointer">
                                <span
                                    class="material-symbols-outlined text-white/20 group-hover:text-primary transition-colors">upload_file</span>
                                <span class="text-sm text-white/40 group-hover:text-white/60">Drop images here or click
                                    to browse</span>
                            </label>
                        </div>
                    </div>

                    <!-- URL Inputs Container -->
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Image
                                URLs</label>
                            <button type="button" onclick="addUrlField()"
                                class="text-[10px] font-bold text-primary hover:text-neon-blue transition-colors uppercase tracking-wider flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">add</span> Add URL
                            </button>
                        </div>
                        <div id="url-fields-container" class="space-y-3">
                            <div class="flex gap-2">
                                <input name="image_urls"
                                    class="flex-1 bg-surface-dark border border-white/10 rounded-xl p-3 text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-white/20"
                                    placeholder="https://example.com/card-image.jpg" type="url"
                                    oninput="updatePreviews()"
                                    value="{% if edit_mode and product.image_urls and product.image_urls|length > 0 %}{{ product.image_urls[0] }}{% endif %}" />
                                <button type="button" onclick="this.parentElement.remove(); updatePreviews();"
                                    class="text-danger-red hover:bg-danger-red/10 p-2 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Appraise Card Button -->
                    {% if not edit_mode %}
                    <div class="flex flex-col gap-3">
                        <button type="button" id="appraise-btn" onclick="enableImageSelection()" disabled
                            class="w-full py-4 rounded-xl bg-gradient-to-r from-neon-purple to-primary text-white font-bold text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg hover:shadow-primary/50">
                            <span class="material-symbols-outlined">auto_fix_high</span>
                            <span>Appraise Card with AI</span>
                        </button>
                        <p class="text-xs text-white/40 text-center">Click to select which card image to analyze</p>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- Toast Notification -->
            <div id="toast" class="fixed top-20 right-4 z-50 hidden">
                <div
                    class="glass-panel rounded-xl p-4 border border-white/10 flex items-start gap-3 max-w-sm shadow-2xl">
                    <span id="toast-icon" class="material-symbols-outlined text-2xl"></span>
                    <div class="flex-1">
                        <h4 id="toast-title" class="font-bold text-sm mb-1"></h4>
                        <p id="toast-message" class="text-xs text-white/70"></p>
                    </div>
                    <button onclick="hideToast()" class="text-white/40 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>
                </div>
            </div>

            <!-- Duplicate Card Modal -->
            <div id="duplicate-modal"
                class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm">
                <div class="glass-panel rounded-2xl p-8 border border-white/10 max-w-md w-full mx-4 shadow-2xl">
                    <div class="flex items-start gap-4 mb-6">
                        <span class="material-symbols-outlined text-4xl text-yellow-400">warning</span>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">Duplicate Card Detected</h3>
                            <p class="text-sm text-white/70">
                                A card with this name already exists:
                            </p>
                            <p class="text-base font-bold text-primary mt-2" id="duplicate-card-name"></p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="editExistingCard()"
                            class="flex-1 py-3 rounded-xl bg-gradient-to-r from-neon-purple to-primary text-white font-bold text-sm hover:shadow-lg hover:shadow-primary/50 transition-all">
                            Edit Existing Card
                        </button>
                        <button onclick="closeDuplicateModal()"
                            class="flex-1 py-3 rounded-xl bg-white/10 text-white font-bold text-sm hover:bg-white/20 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Metadata Section -->
            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Core Info -->
                <div class="glass-panel rounded-2xl p-6 border border-white/10 space-y-5">
                    <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-white/50 mb-2">Core Identity</h3>

                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Card Name <span
                                class="text-red-400">*</span></label>
                        <input name="name" required
                            class="w-full bg-surface-dark border border-white/10 rounded-xl p-4 text-sm focus:ring-2 focus:ring-primary border-transparent outline-none transition-all placeholder:text-white/20"
                            placeholder="e.g. Charizard GX" type="text"
                            value="{{ product.title if edit_mode else '' }}" />
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Description
                            (Optional)</label>
                        <textarea name="description" rows="4" style="white-space: pre-wrap;"
                            class="w-full bg-surface-dark border border-white/10 rounded-xl p-4 text-sm focus:ring-2 focus:ring-primary outline-none transition-all resize-none placeholder:text-white/20"
                            placeholder="Add a description for this card...">{{ product.description if edit_mode else '' }}</textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Sell Price
                                (¥) <span class="text-red-400">*</span></label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/40">¥</span>
                                <input name="price" required
                                    class="w-full bg-surface-dark border border-white/10 rounded-xl p-4 pl-8 text-sm focus:ring-2 focus:ring-primary outline-none transition-all"
                                    placeholder="0" type="number" value="{{ product.price if edit_mode else '' }}" />
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Collections
                                <span class="text-red-400">*</span></label>
                            <div
                                class="w-full bg-surface-dark border border-white/10 rounded-xl p-4 space-y-2 max-h-48 overflow-y-auto">
                                {% for cat in categories %}
                                <label
                                    class="flex items-center gap-3 cursor-pointer hover:bg-white/5 p-2 rounded-lg transition-colors">
                                    <input type="checkbox" name="collections" value="{{ cat }}" {% if edit_mode and
                                        product_collections and cat in product_collections %}checked{% endif %}
                                        class="w-4 h-4 rounded border-white/20 bg-surface-dark text-primary focus:ring-2 focus:ring-primary focus:ring-offset-0 focus:ring-offset-surface-dark collection-checkbox">
                                    <span class="text-sm text-white">{{ cat }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <p class="text-xs text-white/30">Select at least one collection</p>
                            <p id="collection-error" class="text-xs text-red-400 hidden">Please select at least one
                                collection</p>
                        </div>
                    </div>
                </div>

                <!-- TCG Specifics -->
                <div class="glass-panel rounded-2xl p-6 border border-white/10 space-y-5">
                    <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-white/50 mb-2">TCG Parameters</h3>

                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Vendor <span
                                class="text-red-400">*</span></label>
                        <input name="vendor" required
                            value="{% if edit_mode and vendor %}{{ vendor }}{% else %}TCG Nakama{% endif %}"
                            class="w-full bg-surface-dark border border-white/10 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary outline-none transition-all"
                            placeholder="e.g. TCG Nakama" type="text" />
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Set Name</label>
                        <input name="set_name"
                            class="w-full bg-surface-dark border border-white/10 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary outline-none transition-all"
                            placeholder="e.g. VSTAR Universe" type="text"
                            value="{{ product.set if edit_mode else '' }}" />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Card #</label>
                            <input name="card_number"
                                class="w-full bg-surface-dark border border-white/10 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary outline-none transition-all"
                                placeholder="210/172" type="text"
                                value="{{ product.card_number if edit_mode else '' }}" />
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Rarity</label>
                            <select name="rarity"
                                class="w-full bg-surface-dark border border-white/10 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary outline-none transition-all text-white">
                                <option value="Common" {% if edit_mode and product.rarity|lower=='common' %}selected{%
                                    endif %}>Common</option>
                                <option value="Uncommon" {% if edit_mode and product.rarity|lower=='uncommon'
                                    %}selected{% endif %}>Uncommon</option>
                                <option value="Rare" {% if edit_mode and product.rarity|lower=='rare' %}selected{% endif
                                    %}>
                                    Rare</option>
                                <option value="Epic" {% if edit_mode and product.rarity|lower=='epic' %}selected{% endif
                                    %}>
                                    Epic</option>
                                <option value="Ultra Rare" {% if edit_mode and product.rarity|lower=='ultra rare'
                                    %}selected{% endif %}>Ultra Rare</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Condition <span
                                class="text-red-400">*</span></label>
                        <select name="condition" required
                            class="w-full bg-surface-dark border border-white/10 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-primary outline-none transition-all text-white">
                            <option value="Booster Pack" {% if edit_mode and product.condition=='Booster Pack'
                                %}selected{% endif %}>Booster Pack</option>
                            <option value="Slab" {% if edit_mode and product.condition=='Slab' %}selected{% endif %}>
                                Slab</option>
                            <option value="Raw" {% if edit_mode and product.condition=='Raw' %}selected{% endif %}>Raw
                            </option>
                            <option value="Toploader" {% if edit_mode and product.condition=='Toploader' %}selected{%
                                endif %}>Toploader</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Logistics -->
            <section class="glass-panel rounded-2xl p-6 border border-white/10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-white/50">Acquisition</h3>
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Buy Price /
                                Cost (¥)</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/40">¥</span>
                                <input name="buy_price"
                                    class="w-full bg-surface-dark border border-white/10 rounded-xl p-4 pl-8 text-sm focus:ring-2 focus:ring-primary outline-none transition-all"
                                    placeholder="--" type="number" step="0.1"
                                    value="{% if edit_mode and product.buy_price %}{{ product.buy_price }}{% endif %}" />
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-white/50">Initial Vault Stock</h3>
                        <div class="flex items-center gap-6 bg-obsidian-black border border-white/10 rounded-2xl p-4">
                            <button type="button" onclick="updateStock(-1)"
                                class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-neon-blue hover:bg-white/10 transition-colors">
                                <span class="material-symbols-outlined">remove</span>
                            </button>
                            <div class="flex-1 text-center">
                                <span id="stock-display" class="text-2xl font-mono font-bold text-white">{{
                                    product.inventory_quantity if edit_mode else 1 }}</span>
                                <input type="hidden" name="stock" id="stock-input"
                                    value="{{ product.inventory_quantity if edit_mode else 1 }}">
                            </div>
                            <button type="button" onclick="updateStock(1)"
                                class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-neon-blue hover:bg-white/10 transition-colors">
                                <span class="material-symbols-outlined">add</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Submit -->
            <div class="mt-4">
                <button type="submit"
                    class="holo-glow w-full py-5 rounded-2xl text-white font-bold text-lg flex items-center justify-center gap-3 active:scale-[0.98] transition-all duration-200 shadow-xl uppercase tracking-widest">
                    <span class="material-symbols-outlined">auto_awesome</span>
                    Initialize Asset in Vault
                </button>
            </div>
        </form>
    </main>

    <!-- Bottom Nav -->
    <nav
        class="fixed bottom-0 left-0 right-0 glass-panel border-t border-glass-border pb-safe pt-2 px-6 z-50 rounded-t-2xl">
        <div class="flex justify-between items-center h-16 max-w-md mx-auto">
            <button onclick="window.location.href='/admin'"
                class="flex flex-col items-center gap-1 text-white/40 hover:text-white transition-colors group">
                <span
                    class="material-symbols-outlined group-hover:drop-shadow-[0_0_8px_rgba(255,255,255,0.8)] transition-all">grid_view</span>
                <span class="text-[10px] font-bold uppercase tracking-wider">Vault</span>
            </button>
            <button onclick="window.location.href='/admin/add-card'"
                class="flex flex-col items-center gap-1 text-primary group transition-colors">
                <span
                    class="material-symbols-outlined group-hover:drop-shadow-[0_0_8px_rgba(37,123,244,0.8)] transition-all">add_circle</span>
                <span class="text-[10px] font-bold uppercase tracking-wider">Add Card</span>
            </button>
            <button onclick="window.location.href='/admin/analytics'"
                class="flex flex-col items-center gap-1 text-white/40 hover:text-white transition-colors group">
                <span
                    class="material-symbols-outlined group-hover:drop-shadow-[0_0_8px_rgba(255,255,255,0.8)] transition-all">monitoring</span>
                <span class="text-[10px] font-bold uppercase tracking-wider">Analytics</span>
            </button>
            <button onclick="window.location.href='/admin/settings'"
                class="flex flex-col items-center gap-1 text-white/40 hover:text-white transition-colors group">
                <span
                    class="material-symbols-outlined group-hover:drop-shadow-[0_0_8px_rgba(255,255,255,0.8)] transition-all">settings</span>
                <span class="text-[10px] font-bold uppercase tracking-wider">Settings</span>
            </button>
        </div>
    </nav>

    <script>
        function updateStock(delta) {
            const display = document.getElementById('stock-display');
            const input = document.getElementById('stock-input');
            let val = parseInt(display.innerText) + delta;
            if (val < 1) val = 1;
            display.innerText = val;
            input.value = val;
        }

        function addUrlField() {
            const container = document.getElementById('url-fields-container');
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <input name="image_urls"
                    class="flex-1 bg-surface-dark border border-white/10 rounded-xl p-3 text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-white/20"
                    placeholder="https://example.com/card-image.jpg" type="url" oninput="updatePreviews()"/>
                <button type="button" onclick="this.parentElement.remove(); updatePreviews();" class="text-danger-red hover:bg-danger-red/10 p-2 rounded-lg transition-colors">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            `;
            container.appendChild(div);
        }

        function handleFileSelect(input) {
            updatePreviews();
        }

        function updatePreviews() {
            const container = document.getElementById('image-previews');
            container.innerHTML = '';

            // Handle URL previews
            const urlInputs = document.getElementsByName('image_urls');
            urlInputs.forEach((input, index) => {
                if (input.value && (input.value.match(/\.(jpeg|jpg|gif|png|webp)$/) != null || input.value.startsWith('http'))) {
                    addPreviewItem(input.value, container, 'url', index);
                }
            });

            // Handle File previews
            const fileInput = document.getElementById('file-input');
            if (fileInput.files) {
                Array.from(fileInput.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        addPreviewItem(e.target.result, container, 'file', index);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function addPreviewItem(src, container, type, index) {
            const div = document.createElement('div');
            div.className = 'flex-none w-24 aspect-[3/4] rounded-lg border border-white/10 bg-white/5 overflow-hidden snap-start relative group';
            div.innerHTML = `
                <img src="${src}" class="w-full h-full object-cover" onerror="this.src='https://images.pokemontcg.io/bg.jpg'">
                <button type="button" 
                    onclick="deletePreviewImage('${type}', ${index})" 
                    class="absolute top-1 right-1 bg-danger-red/80 hover:bg-danger-red text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="material-symbols-outlined text-sm">delete</span>
                </button>
            `;
            container.appendChild(div);
        }

        function deletePreviewImage(type, index) {
            if (type === 'url') {
                // Remove the URL input field
                const urlInputs = document.getElementsByName('image_urls');
                if (urlInputs[index]) {
                    urlInputs[index].parentElement.remove();
                    updatePreviews();
                }
            } else if (type === 'file') {
                // For files, we need to clear the file input and recreate it without this file
                const fileInput = document.getElementById('file-input');
                const dt = new DataTransfer();
                const files = Array.from(fileInput.files);

                files.forEach((file, i) => {
                    if (i !== index) {
                        dt.items.add(file);
                    }
                });

                fileInput.files = dt.files;
                updatePreviews();
            }
        }

        // Duplicate detection variables
        let duplicateProductId = null;
        let bypassDuplicateCheck = false;

        // Check for duplicate card before submission
        async function checkDuplicateAndSubmit(event) {
            console.log('[DUPLICATE CHECK] Form submission triggered');

            // Prevent default form submission
            event.preventDefault();

            // Check if we're in edit mode
            const editMode = document.querySelector('input[name="product_id"]') !== null;
            console.log('[DUPLICATE CHECK] Edit mode:', editMode, 'Bypass:', bypassDuplicateCheck);

            // Get card name early to check if it changed
            const cardNameInput = document.querySelector('input[name="name"]');
            const currentCardName = cardNameInput ? cardNameInput.value.trim() : '';

            // In edit mode, check if the card name has changed
            let nameChanged = false;
            if (editMode) {
                // Get the original card name from the product data
                const originalName = "{{ product.title if edit_mode else '' }}";
                nameChanged = currentCardName !== originalName;
                console.log('[DUPLICATE CHECK] Original name:', originalName);
                console.log('[DUPLICATE CHECK] Current name:', currentCardName);
                console.log('[DUPLICATE CHECK] Name changed:', nameChanged);
            }

            // If we're in edit mode and name hasn't changed, OR bypassing duplicate check, proceed with validation
            if ((editMode && !nameChanged) || bypassDuplicateCheck) {
                console.log('[DUPLICATE CHECK] Bypassing duplicate check, running validation');
                // Run validation
                if (showLoading()) {
                    console.log('[DUPLICATE CHECK] Validation passed, submitting form');
                    // Remove the onsubmit handler to prevent infinite loop
                    event.target.onsubmit = null;
                    // Validation passed, submit the form
                    event.target.submit();
                } else {
                    console.log('[DUPLICATE CHECK] Validation failed');
                }
                return false;
            }

            // Get card name and rarity (already got cardNameInput above)
            // const cardNameInput = document.querySelector('input[name="name"]'); // Removed duplicate declaration

            console.log('[DUPLICATE CHECK] Card name input:', cardNameInput);

            if (!cardNameInput) {
                console.error('[DUPLICATE CHECK] Could not find card name input');
                // Proceed with normal validation if input not found
                if (showLoading()) {
                    event.target.onsubmit = null;
                    event.target.submit();
                }
                return false;
            }

            const cardName = cardNameInput.value.trim();

            console.log('[DUPLICATE CHECK] Card name:', cardName);

            if (!cardName) {
                console.log('[DUPLICATE CHECK] No card name, proceeding with normal validation');
                // If no card name, proceed with normal validation
                if (showLoading()) {
                    event.target.onsubmit = null;
                    event.target.submit();
                }
                return false;
            }

            try {
                console.log('[DUPLICATE CHECK] Calling duplicate check endpoint');

                // Read card_number directly from the form field (user may have edited it after appraisal)
                const cardNumberInput = document.querySelector('input[name="card_number"]');
                const cardNumber = cardNumberInput ? cardNumberInput.value.trim() : '';
                console.log('[DUPLICATE CHECK] Card number from form:', cardNumber);

                // Build the API URL - include current product ID if in edit mode
                let apiUrl = `/admin/check-duplicate-card?card_name=${encodeURIComponent(cardName)}`;
                if (cardNumber) {
                    apiUrl += `&card_number=${encodeURIComponent(cardNumber)}`;
                }
                if (editMode) {
                    const currentProductId = document.querySelector('input[name="product_id"]').value;
                    apiUrl += `&current_product_id=${encodeURIComponent(currentProductId)}`;
                    console.log('[DUPLICATE CHECK] Edit mode - excluding current product:', currentProductId);
                }

                // Call duplicate check endpoint
                const response = await fetch(apiUrl);
                const data = await response.json();

                console.log('[DUPLICATE CHECK] Response:', data);

                if (data.exists) {
                    console.log('[DUPLICATE CHECK] Duplicate found, showing modal');
                    // Show duplicate modal
                    duplicateProductId = data.product_id;
                    document.getElementById('duplicate-card-name').textContent = data.product_title;
                    document.getElementById('duplicate-modal').classList.remove('hidden');
                    document.getElementById('duplicate-modal').classList.add('flex');
                    return false;
                } else {
                    console.log('[DUPLICATE CHECK] No duplicate, proceeding with submission');
                    // No duplicate, proceed with validation and submission
                    bypassDuplicateCheck = true;
                    if (showLoading()) {
                        console.log('[DUPLICATE CHECK] Submitting form');
                        event.target.onsubmit = null;
                        event.target.submit();
                    }
                }
            } catch (error) {
                console.error('[DUPLICATE CHECK] Error:', error);
                // On error, proceed with normal validation and submission
                bypassDuplicateCheck = true;
                if (showLoading()) {
                    event.target.onsubmit = null;
                    event.target.submit();
                }
            }

            return false;
        }

        // Close duplicate modal
        function closeDuplicateModal() {
            document.getElementById('duplicate-modal').classList.add('hidden');
            document.getElementById('duplicate-modal').classList.remove('flex');
            duplicateProductId = null;
        }

        // Redirect to edit existing card
        function editExistingCard() {
            if (duplicateProductId) {
                // URL-encode to preserve special characters like :// in Shopify GIDs
                window.location.href = `/admin/edit-card?product_id=${encodeURIComponent(duplicateProductId)}`;
            }
        }

        function showLoading() {
            // Validate at least one collection is selected
            const checkboxes = document.querySelectorAll('.collection-checkbox');
            const isChecked = Array.from(checkboxes).some(cb => cb.checked);

            if (!isChecked) {
                document.getElementById('collection-error').classList.remove('hidden');
                return false;
            }

            // Check if we're in edit mode
            const editMode = document.querySelector('input[name="product_id"]') !== null;

            // Validate at least one image is provided (ONLY in add mode, not edit mode)
            if (!editMode) {
                const fileInput = document.getElementById('file-input');
                const urlInputs = document.getElementsByName('image_urls');
                const hasFiles = fileInput.files && fileInput.files.length > 0;
                const hasUrls = Array.from(urlInputs).some(input => input.value.trim() !== '');

                if (!hasFiles && !hasUrls) {
                    document.getElementById('image-error').classList.remove('hidden');
                    document.getElementById('collection-error').classList.add('hidden');
                    return false;
                }
            }

            document.getElementById('image-error').classList.add('hidden');

            document.getElementById('collection-error').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('flex');
            return true;
        }

        // Toast notification functions
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const titleEl = document.getElementById('toast-title');
            const messageEl = document.getElementById('toast-message');

            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;

            // Set icon and color based on type
            if (type === 'success') {
                icon.textContent = 'check_circle';
                icon.className = 'material-symbols-outlined text-2xl text-neon-green';
            } else if (type === 'error') {
                icon.textContent = 'error';
                icon.className = 'material-symbols-outlined text-2xl text-danger-red';
            } else if (type === 'loading') {
                icon.textContent = 'progress_activity';
                icon.className = 'material-symbols-outlined text-2xl text-primary animate-spin';
            }

            // Show toast
            toast.classList.remove('hidden');

            // Auto-hide after 5 seconds (unless loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    hideToast();
                }, 5000);
            }
        }

        function hideToast() {
            document.getElementById('toast').classList.add('hidden');
        }

        // Image selection mode for appraisal
        let selectionMode = false;
        let imageMetadata = []; // Store metadata about each image (file or URL)

        function enableImageSelection() {
            selectionMode = true;
            const previews = document.getElementById('image-previews');
            const images = previews.querySelectorAll('div');

            if (images.length === 0) {
                showToast('No Images', 'Please upload at least one image first', 'error');
                return;
            }

            // Add selection borders to all images
            images.forEach((imgDiv, index) => {
                imgDiv.classList.add('ring-4', 'ring-primary', 'ring-opacity-50', 'cursor-pointer');
                imgDiv.onclick = () => selectImageForAppraisal(index);
            });

            // Update button text
            document.getElementById('appraise-btn').innerHTML = `
                <span class="material-symbols-outlined">touch_app</span>
                <span>Click on an image to appraise</span>
            `;

            showToast('Select Image', 'Click on the card image you want to analyze', 'loading');
        }

        async function selectImageForAppraisal(index) {
            if (!selectionMode) return;

            // Disable selection mode
            selectionMode = false;
            const previews = document.getElementById('image-previews');
            const images = previews.querySelectorAll('div');

            // Remove selection borders from all images
            images.forEach((imgDiv, i) => {
                imgDiv.classList.remove('ring-4', 'ring-primary', 'ring-opacity-50', 'cursor-pointer');
                imgDiv.onclick = null;

                // Highlight the selected image
                if (i === index) {
                    imgDiv.classList.add('ring-4', 'ring-neon-green', 'ring-opacity-100');
                    // Add checkmark overlay
                    const checkmark = document.createElement('div');
                    checkmark.className = 'absolute top-2 right-2 bg-neon-green text-black rounded-full p-1';
                    checkmark.innerHTML = '<span class="material-symbols-outlined text-sm">check</span>';
                    imgDiv.appendChild(checkmark);
                }
            });

            // Reset button
            document.getElementById('appraise-btn').innerHTML = `
                <span class="material-symbols-outlined">auto_fix_high</span>
                <span>Appraise Card with AI</span>
            `;

            // Show loading toast
            hideToast();
            showToast('Analyzing Card', 'Gemini AI is analyzing your card...', 'loading');

            // Get image data
            const fileInput = document.getElementById('file-input');
            const urlInputs = document.getElementsByName('image_urls');
            const validUrls = Array.from(urlInputs).filter(input => input.value.trim() !== '').map(input => input.value.trim());

            let formData = new FormData();

            // Determine if this is a file or URL
            const totalFiles = fileInput.files ? fileInput.files.length : 0;

            if (index < totalFiles) {
                // This is a file upload
                formData.append('image_file', fileInput.files[index]);
            } else {
                // This is a URL
                const urlIndex = index - totalFiles;
                if (urlIndex < validUrls.length) {
                    formData.append('image_url', validUrls[urlIndex]);
                }
            }

            try {
                const response = await fetch('/admin/appraise-card-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const data = result.data;

                    // Auto-populate form fields
                    if (data.card_name) {
                        document.querySelector('input[name="name"]').value = data.card_name;
                    }
                    if (data.set_name) {
                        document.querySelector('input[name="set_name"]').value = data.set_name;
                    }
                    if (data.card_number) {
                        document.querySelector('input[name="card_number"]').value = data.card_number;
                    }
                    if (data.rarity) {
                        const raritySelect = document.querySelector('select[name="rarity"]');
                        // Try to find matching option
                        const options = Array.from(raritySelect.options);
                        const matchingOption = options.find(opt => opt.value.toLowerCase() === data.rarity.toLowerCase());
                        if (matchingOption) {
                            raritySelect.value = matchingOption.value;
                        }
                    }
                    if (data.manufacturer) {
                        document.querySelector('input[name="vendor"]').value = data.manufacturer;
                    }

                    // Build description with scanned information in bulleted form
                    let description = '**Card Detailed Information:**\n\n';
                    if (data.card_name_japanese) {
                        description += `• **Japanese Name:** ${data.card_name_japanese}\n`;
                    }
                    if (data.card_name_english) {
                        description += `• **English Name:** ${data.card_name_english}\n`;
                    }
                    if (data.set_name) {
                        description += `• **Set:** ${data.set_name}\n`;
                    }
                    if (data.card_number) {
                        description += `• **Card Number:** ${data.card_number}\n`;
                    }
                    if (data.rarity) {
                        description += `• **Rarity:** ${data.rarity}\n`;
                    }
                    if (data.year) {
                        description += `• **Year:** ${data.year}\n`;
                    }
                    if (data.manufacturer) {
                        description += `• **Manufacturer:** ${data.manufacturer}\n`;
                    }

                    // Set description
                    const descriptionField = document.querySelector('textarea[name="description"]');
                    if (descriptionField) {
                        descriptionField.value = description;
                    }

                    // Remove selection highlight
                    const previews = document.getElementById('image-previews');
                    const images = previews.querySelectorAll('div');
                    images.forEach(imgDiv => {
                        imgDiv.classList.remove('ring-4', 'ring-neon-green', 'ring-opacity-100');
                        // Remove checkmark if exists
                        const checkmark = imgDiv.querySelector('.absolute.top-2.right-2');
                        if (checkmark) checkmark.remove();
                    });

                    hideToast();
                    showToast(
                        'Appraisal Complete!',
                        `Identified: ${data.card_name_english || data.card_name_japanese || 'Unknown'} - ${data.rarity || 'Unknown rarity'}. Fetching market value...`,
                        'loading'
                    );

                    // Fetch market value using the same appraisal system as admin dashboard
                    console.log('[APPRAISE] About to call fetchMarketValue with data:', data);
                    fetchMarketValue(data);
                } else {
                    // Remove selection highlight on error too
                    const previews = document.getElementById('image-previews');
                    const images = previews.querySelectorAll('div');
                    images.forEach(imgDiv => {
                        imgDiv.classList.remove('ring-4', 'ring-neon-green', 'ring-opacity-100');
                        const checkmark = imgDiv.querySelector('.absolute.top-2.right-2');
                        if (checkmark) checkmark.remove();
                    });

                    hideToast();
                    showToast('Appraisal Failed', result.error || 'Could not analyze the card', 'error');
                }
            } catch (error) {
                // Remove selection highlight on error
                const previews = document.getElementById('image-previews');
                const images = previews.querySelectorAll('div');
                images.forEach(imgDiv => {
                    imgDiv.classList.remove('ring-4', 'ring-neon-green', 'ring-opacity-100');
                    const checkmark = imgDiv.querySelector('.absolute.top-2.right-2');
                    if (checkmark) checkmark.remove();
                });

                hideToast();
                showToast('Error', 'Failed to connect to appraisal service', 'error');
                console.error('Appraisal error:', error);
            }
        }

        // Update appraise button state when images change
        function updateAppraiseButton() {
            const fileInput = document.getElementById('file-input');
            const urlInputs = document.getElementsByName('image_urls');
            const hasFiles = fileInput.files && fileInput.files.length > 0;
            const hasUrls = Array.from(urlInputs).some(input => input.value.trim() !== '');

            const appraiseBtn = document.getElementById('appraise-btn');
            if (hasFiles || hasUrls) {
                appraiseBtn.disabled = false;
            } else {
                appraiseBtn.disabled = true;
            }
        }

        // Override existing functions to also update appraise button
        const originalHandleFileSelect = handleFileSelect;
        handleFileSelect = function (input) {
            originalHandleFileSelect(input);
            updateAppraiseButton();
        };

        const originalUpdatePreviews = updatePreviews;
        updatePreviews = function () {
            originalUpdatePreviews();
            updateAppraiseButton();
        };

        // Initialize previews and additional URL fields on page load for edit mode
        document.addEventListener('DOMContentLoaded', function () {
            {% if edit_mode and product.image_urls and product.image_urls | length > 1 %}
            const container = document.getElementById('url-fields-container');
            const imageUrls = {{ product.image_urls| tojson
        }};

        // Add additional URL fields for remaining images (first one is already in HTML)
        for (let i = 1; i < imageUrls.length; i++) {
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                    <input name="image_urls" 
                        class="flex-1 bg-surface-dark border border-white/10 rounded-xl p-3 text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder:text-white/20" 
                        placeholder="https://example.com/card-image.jpg" 
                        type="url" 
                        oninput="updatePreviews()" 
                        value="${imageUrls[i]}" />
                    <button type="button" onclick="this.parentElement.remove(); updatePreviews();" class="text-danger-red hover:bg-danger-red/10 p-2 rounded-lg transition-colors">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                `;
            container.appendChild(div);
        }
        {% endif %}

        // Trigger preview update on page load for edit mode
        {% if edit_mode %}
        updatePreviews();
        {% endif %}
        });

        // Fetch market value using the same appraisal system as admin dashboard
        async function fetchMarketValue(cardData) {
            console.log('[FETCH_MARKET_VALUE] Function called with:', cardData);
            try {
                // Build query parameters for the appraisal API
                const params = new URLSearchParams();

                // Use English name for market lookup (more common in pricing databases)
                const cardName = cardData.card_name_english || cardData.card_name_japanese || '';
                params.append('card_name', cardName);
                params.append('set_name', cardData.set_name || '');
                params.append('card_number', cardData.card_number || '');
                params.append('rarity', cardData.rarity || '');

                // Detect Japanese: card has a Japanese name
                const isJapanese = !!(cardData.card_name_japanese && cardData.card_name_japanese.trim());
                params.append('is_japanese', isJapanese);
                console.log('[FETCH_MARKET_VALUE] is_japanese:', isJapanese);

                // Call the market value estimation endpoint (create a temporary product-like structure)
                const apiUrl = `/admin/estimate-market-value?${params.toString()}`;
                console.log('[FETCH_MARKET_VALUE] Calling API:', apiUrl);
                const response = await fetch(apiUrl);
                console.log('[FETCH_MARKET_VALUE] Response:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error('Failed to fetch market value');
                }

                const result = await response.json();
                console.log('[FETCH_MARKET_VALUE] Result:', result);

                if (result.market_value_jpy) {
                    // Set the price field with the market value in JPY
                    const priceField = document.querySelector('input[name="price"]');
                    if (priceField) {
                        priceField.value = Math.round(result.market_value_jpy);
                    }

                    hideToast();
                    showToast(
                        'Price Set!',
                        `Market value: ¥${Math.round(result.market_value_jpy).toLocaleString()} (${result.market_value_usd ? '$' + result.market_value_usd.toFixed(2) : 'N/A'})`,
                        'success'
                    );
                } else {
                    hideToast();
                    showToast(
                        'Appraisal Complete!',
                        'Card identified, but market value not available. Please set price manually.',
                        'success'
                    );
                }
            } catch (error) {
                console.error('Market value fetch error:', error);
                hideToast();
                showToast(
                    'Appraisal Complete!',
                    'Card identified, but market value unavailable. Please set price manually.',
                    'success'
                );
            }
        }
    </script>

</html>