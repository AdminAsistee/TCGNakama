{% extends "base.html" %}

{% block content %}
<!-- ==================== HEADER / NAVBAR ==================== -->
<header class="sticky top-0 z-50 bg-background-dark/90 backdrop-blur-md border-b border-white/5">
    <div class="flex items-center p-3 px-4 md:p-4 md:px-6 justify-between max-w-7xl mx-auto">
        <!-- Logo -->
        <div class="flex items-center gap-2">
            <img src="/static/logo.png" alt="TCG Nakama" class="h-8 w-auto rounded-full">
            <h1 class="text-lg font-bold tracking-tight text-primary">TCGNakama</h1>
        </div>

        <!-- Desktop Nav -->
        <nav class="hidden md:flex items-center gap-6">
            <a href="/" class="text-sm font-semibold text-primary border-b-2 border-primary pb-1">Home</a>
            <a href="#all-cards-section"
                class="text-sm font-medium text-gray-400 hover:text-white transition-colors">Shop</a>

            <!-- My Collection dropdown -->
            <div class="relative group">
                <button
                    class="text-sm font-medium text-gray-400 hover:text-white transition-colors flex items-center gap-1 pb-1">
                    Collection
                    <span class="material-symbols-outlined text-xs">expand_more</span>
                </button>
                <div
                    class="absolute top-full left-0 mt-1 w-auto min-w-[200px] bg-surface border border-white/10 rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 overflow-hidden z-50">
                    {% for collection in collections %}
                    <a href="#all-cards-section"
                        onclick="event.preventDefault(); shopCollection('{{ collection.handle }}')"
                        class="block px-4 py-3 text-sm text-white font-medium hover:bg-white/5 transition-colors whitespace-nowrap">{{
                        collection.title }}</a>
                    {% endfor %}
                </div>
            </div>

            <!-- Community (coming soon) -->
            <span class="text-sm font-medium text-gray-600 cursor-default flex items-center gap-1.5">
                Community
                <span
                    class="text-[8px] font-bold bg-white/5 text-gray-500 px-1.5 py-0.5 rounded-full uppercase">Soon</span>
            </span>
        </nav>

        <!-- Cart -->
        <button id="cart-btn"
            class="relative w-9 h-9 md:w-10 md:h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition-colors"
            hx-get="/cart/drawer" hx-target="#cart-drawer-container">
            <span class="material-symbols-outlined text-white text-xl">shopping_cart</span>
            <span id="cart-count"
                class="absolute -top-1 -right-1 w-5 h-5 bg-neon-red text-[10px] font-black text-white rounded-full flex items-center justify-center">{{
                cart_count }}</span>
        </button>
    </div>

    <!-- Search Bar -->
    <div class="px-3 pb-3 md:px-6 md:pb-4 max-w-7xl mx-auto">
        <label class="flex flex-col w-full relative">
            <div
                class="flex w-full items-stretch rounded-full h-10 md:h-11 bg-white/5 border border-white/10 focus-within:border-primary/50 transition-colors">
                <div class="text-gray-400 flex items-center justify-center pl-4">
                    <span class="material-symbols-outlined text-lg">search</span>
                </div>
                <input id="search-input" name="q"
                    class="form-input w-full bg-transparent border-none focus:ring-0 text-sm placeholder:text-gray-500 text-white"
                    placeholder='Search for cards, sets, or investment picks...' type="text" hx-get="/search"
                    hx-trigger="keyup changed delay:300ms" hx-target="#product-grid" hx-indicator="#search-loading"
                    hx-include="#filter-form" hx-on:input="clearFilterVisuals()" />
                <div class="flex items-center pr-4 gap-2">
                    <div id="search-loading" class="htmx-indicator">
                        <span class="material-symbols-outlined text-primary text-sm animate-spin">sync</span>
                    </div>
                    <span class="material-symbols-outlined text-gray-500 text-lg">mic</span>
                </div>
            </div>
        </label>


    </div>
</header>

<main class="max-w-7xl mx-auto min-h-screen pb-24 px-4 md:px-6">

    <!-- ==================== HERO BANNER CAROUSEL ==================== -->
    <section id="hero-carousel" class="mt-6 relative rounded-2xl overflow-hidden h-56 md:h-96">
        <!-- Mobile: 224px, Desktop: 384px - increased height to show more of 1920x480 banner -->
        <!-- Slides Container -->
        <div id="carousel-track" class="flex transition-transform duration-500 ease-out h-full"
            style="width: {{ banners|length * 100 }}%;">
            {% for banner in banners %}
            <div class="relative h-full flex-shrink-0" style="width: {{ 100 / banners|length }}%;">
                <!-- Background: image or gradient -->
                {% if banner.image %}
                <img src="{{ banner.image }}" alt="{{ banner.title }}"
                    class="absolute inset-0 w-full h-full object-cover">
                {% else %}
                <div class="absolute inset-0 bg-gradient-to-r {{ banner.gradient }}"></div>
                {% endif %}
                <!-- Glassmorphism Overlay -->
                <div
                    class="absolute inset-0 bg-gradient-to-r from-background-dark/80 via-background-dark/50 to-transparent">
                </div>
                <!-- Content -->
                <div class="relative h-full flex flex-col items-center justify-center text-center px-6">
                    <h2 class="text-xl md:text-2xl font-bold text-white mb-1">{{ banner.title }}</h2>
                    <p class="text-xs text-gray-300 mb-4">{{ banner.subtitle }}</p>
                    {% if banner.cta_link.startswith('#collection:') %}
                    <a href="#all-cards-section"
                        onclick="event.preventDefault(); shopCollection('{{ banner.cta_link.replace('#collection:', '') }}')"
                        class="px-6 py-2 bg-primary text-background-dark font-bold text-sm rounded-full hover:bg-primary-dark transition-colors shadow-lg gold-glow">
                        {{ banner.cta_label }}
                    </a>
                    {% else %}
                    <a href="{{ banner.cta_link }}"
                        class="px-6 py-2 bg-primary text-background-dark font-bold text-sm rounded-full hover:bg-primary-dark transition-colors shadow-lg gold-glow">
                        {{ banner.cta_label }}
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Nav Arrows -->
        <button onclick="carouselPrev()"
            class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 bg-white/10 backdrop-blur rounded-full flex items-center justify-center hover:bg-white/20 transition-colors hidden md:flex z-10">
            <span class="material-symbols-outlined text-white text-lg">chevron_left</span>
        </button>
        <button onclick="carouselNext()"
            class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 bg-white/10 backdrop-blur rounded-full flex items-center justify-center hover:bg-white/20 transition-colors hidden md:flex z-10">
            <span class="material-symbols-outlined text-white text-lg">chevron_right</span>
        </button>

        <!-- Dot Indicators -->
        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2 z-10">
            {% for banner in banners %}
            <button onclick="carouselGoto({{ loop.index0 }})"
                class="carousel-dot w-2 h-2 rounded-full transition-all duration-300 {{ 'bg-primary w-6' if loop.index0 == 0 else 'bg-white/40' }}"
                data-index="{{ loop.index0 }}"></button>
            {% endfor %}
        </div>
    </section>

    <!-- ==================== FRESH PULLS (LIVE) ==================== -->
    <section class="mt-8">
        <div class="flex items-center gap-3 mb-4">
            <h3 class="text-lg font-bold flex items-center gap-2">
                üî• Fresh Pulls
            </h3>
            <span
                class="flex items-center gap-1.5 bg-neon-red/20 text-neon-red text-[10px] font-black uppercase tracking-wider px-2 py-1 rounded-full">
                <span class="w-1.5 h-1.5 bg-neon-red rounded-full live-pulse"></span>
                LIVE
            </span>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 md:gap-4">
            {% for product in fresh_pulls %}
            <div
                class="flex flex-col bg-surface rounded-xl border border-vault-border overflow-hidden hover:border-primary/30 transition-all group">
                <!-- Listed Badge -->
                <div class="relative">
                    <div
                        class="absolute top-2 left-2 z-10 flex items-center gap-1 bg-black/70 backdrop-blur-sm rounded-md px-1.5 py-0.5">
                        <span class="w-1.5 h-1.5 bg-neon-green rounded-full"></span>
                        <span class="text-[8px] font-bold text-white">Listed {{ product.listed_ago }}</span>
                    </div>
                    <div class="aspect-[3/4] overflow-hidden cursor-pointer" hx-get="/product/{{ product.id }}"
                        hx-target="#modal-container" hx-swap="innerHTML">
                        <img src="{{ product.image }}{% if '?' in product.image %}&{% else %}?{% endif %}width=300"
                            alt="{{ product.title }}"
                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                            loading="lazy">
                    </div>
                </div>

                <!-- Info -->
                <div class="p-2 space-y-1">
                    <p class="text-[11px] font-semibold text-white/90 truncate">{{ product.title }}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-black text-primary">¬•{{ "{:,.0f}".format(product.price) }}</span>
                        <button onclick="handleCartAction('{{ product.variant_id }}', 'add', event)"
                            class="w-7 h-7 rounded-full bg-primary text-background-dark flex items-center justify-center hover:bg-primary-dark active:scale-90 transition-all">
                            <span class="material-symbols-outlined text-sm font-bold">add</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- ==================== WHAT'S HOT (INVESTOR FOCUS) ==================== -->
    <section class="mt-10">
        <h3 class="text-lg font-bold flex items-center gap-2 mb-4">
            üìà What's Hot <span class="text-sm font-normal text-gray-400">(Investor Focus)</span>
        </h3>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
            {% for product in hot_picks %}
            <div
                class="flex flex-col bg-surface rounded-xl border border-vault-border overflow-hidden hover:border-primary/30 transition-all">
                <!-- Hype Velocity Bar -->
                <div class="hype-bar w-full" style="--hype: {{ product.hype_pct }}%"></div>

                <div class="p-3 flex flex-col gap-2">
                    <div class="flex gap-2 items-start">
                        <!-- Card Image -->
                        <div class="w-16 sm:w-20 md:w-24 aspect-[3/4] rounded-lg overflow-hidden flex-shrink-0 cursor-pointer"
                            hx-get="/product/{{ product.id }}" hx-target="#modal-container" hx-swap="innerHTML">
                            <img src="{{ product.image }}{% if '?' in product.image %}&{% else %}?{% endif %}width=200"
                                alt="{{ product.title }}" class="w-full h-full object-cover" loading="lazy">
                        </div>

                        <!-- Info + Graph -->
                        <div class="flex flex-col flex-1 min-w-0 justify-between h-full">
                            <!-- Graph -->
                            <div class="flex items-center justify-end gap-1">
                                <svg class="mini-graph" width="50" height="24" viewBox="0 0 50 24">
                                    <polyline fill="none" stroke="#22C55E" stroke-width="1.5" stroke-linecap="round"
                                        points="0,20 8,18 16,15 22,16 28,12 34,10 40,8 46,4 50,2" />
                                </svg>
                                <span class="text-[11px] font-bold text-neon-green">+{{ product.growth }}%</span>
                            </div>

                            <!-- Price -->
                            <p class="text-sm md:text-base font-black text-white text-right mt-1">¬•{{
                                "{:,.0f}".format(product.price) }}</p>
                        </div>
                    </div>

                    <!-- Buy Now Button -->
                    <button onclick="handleCartAction('{{ product.variant_id }}', 'buy', event)"
                        class="w-full py-1.5 bg-primary/10 border border-primary/30 text-primary text-xs font-black uppercase tracking-wider rounded-md hover:bg-primary/20 active:scale-95 transition-all">
                        BUY NOW
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- ==================== ALL PRODUCTS (VAULT GRAILS) ==================== -->
    <section id="all-cards-section" class="mt-10 scroll-mt-32">
        <div id="filter-sticky-bar"
            class="sticky z-40 bg-background-dark/95 backdrop-blur-sm py-2 md:py-3 border-b border-white/5 mt-4 md:mt-8 mb-6 md:mb-10">
            <form id="filter-form" hx-get="/filter" hx-target="#product-grid" hx-indicator="#grid-loading"
                hx-trigger="change" hx-include="#search-input">
                <!-- Hidden Inputs for Additive Filtering -->
                <input type="hidden" name="rarity" id="rarity-input" value="" />
                <input type="hidden" name="collection" id="collection-input" value="" />
                <input type="hidden" name="condition" id="condition-input" value="" hx-get="/products"
                    hx-target="#product-grid" hx-swap="outerHTML"
                    hx-include="[name='rarity'], [name='collection'], [name='condition'], [name='min_price'], [name='max_price']" />
                <input type="hidden" name="max_price" id="price-slider" value="" />

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE: Compact Filter Bar ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="md:hidden px-3 py-1">
                    <div class="flex items-center justify-between">
                        <button type="button" onclick="openFilterSheet()"
                            class="flex items-center gap-2 h-10 px-4 rounded-full border border-white/10 bg-white/5 active:bg-white/10 transition-all">
                            <span class="material-symbols-outlined text-gray-300 text-lg">tune</span>
                            <span class="text-[11px] font-bold uppercase tracking-wider text-gray-300">Filter</span>
                            <span id="mobile-filter-count"
                                class="hidden text-[9px] font-black bg-primary text-background-dark w-5 h-5 rounded-full flex items-center justify-center">0</span>
                        </button>
                        <button type="button" onclick="resetFilters()"
                            class="text-[11px] font-bold text-gray-500 hover:text-primary uppercase tracking-wider transition-colors px-3 h-10 hidden"
                            id="mobile-clear-btn">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DESKTOP: Inline Filter Bar (unchanged) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hidden md:flex items-center gap-3">
                    <!-- Resync Button (outside the filter box) -->
                    <button type="button" onclick="resyncShopifyProducts()" id="resync-btn"
                        class="flex items-center gap-2 h-9 px-4 rounded-full border border-primary/30 bg-primary/10 hover:bg-primary/20 transition-all group">
                        <span class="material-symbols-outlined text-primary text-sm" id="resync-icon">sync</span>
                        <span class="text-[10px] font-bold uppercase tracking-wider text-primary">Resync</span>
                    </button>

                    <!-- Filter Box -->
                    <div class="flex-1 px-4 py-3 bg-white/[0.02] rounded-xl border border-white/5">
                        <div class="flex items-center justify-between gap-3">
                            <!-- Price Filter -->
                            <div class="flex items-center gap-3">
                                {% include "partials/price_filter.html" %}
                                <div class="w-px h-5 bg-white/10 shrink-0"></div>
                            </div>

                            <!-- Filter Dropdowns -->
                            <div class="flex items-center gap-1 flex-1">
                                <!-- Rarity Dropdown -->
                                <div class="relative filter-dropdown" data-filter-group="rarity">
                                    <button type="button" onclick="toggleFilterDropdown('rarity')"
                                        class="flex items-center gap-1.5 h-9 px-3 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 transition-all cursor-pointer">
                                        <span
                                            class="text-[10px] font-bold uppercase tracking-wider text-gray-300">Rarity</span>
                                        <span
                                            class="material-symbols-outlined text-gray-400 text-sm transition-transform"
                                            id="rarity-chevron">expand_more</span>
                                        <span id="rarity-badge"
                                            class="hidden text-[8px] font-black bg-primary text-background-dark px-1.5 py-0.5 rounded-full uppercase"></span>
                                    </button>
                                    <div id="rarity-dropdown-panel"
                                        class="absolute top-full left-0 mt-2 w-auto min-w-[160px] bg-surface border border-white/10 rounded-xl shadow-2xl opacity-0 invisible transition-all duration-200 overflow-hidden z-50 p-2 flex flex-col gap-1">
                                        {% set rarities = ['Common', 'Uncommon', 'Rare', 'Epic', 'Ultra Rare'] %}
                                        {% for r in rarities %}
                                        <button type="button" data-rarity-btn="{{ r }}"
                                            onclick="setActiveFilter('{{ r }}', this)"
                                            class="flex items-center px-3 py-2 rounded-lg text-[11px] font-bold uppercase tracking-wider text-gray-300 hover:bg-white/10 hover:text-white transition-all text-left whitespace-nowrap">
                                            {{ r }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Condition Dropdown -->
                                <div class="relative filter-dropdown" data-filter-group="condition">
                                    <button type="button" onclick="toggleFilterDropdown('condition')"
                                        class="flex items-center gap-1.5 h-9 px-3 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 transition-all cursor-pointer">
                                        <span
                                            class="text-[10px] font-bold uppercase tracking-wider text-gray-300">Condition</span>
                                        <span
                                            class="material-symbols-outlined text-gray-400 text-sm transition-transform"
                                            id="condition-chevron">expand_more</span>
                                        <span id="condition-badge"
                                            class="hidden text-[8px] font-black bg-primary text-background-dark px-1.5 py-0.5 rounded-full uppercase"></span>
                                    </button>
                                    <div id="condition-dropdown-panel"
                                        class="absolute top-full left-0 mt-2 w-auto min-w-[160px] bg-surface border border-white/10 rounded-xl shadow-2xl opacity-0 invisible transition-all duration-200 overflow-hidden z-50 p-2 flex flex-col gap-1">
                                        {% set conditions = ['Booster Pack', 'Raw', 'Slab', 'Toploader'] %}
                                        {% for c in conditions %}
                                        <button type="button" data-condition-btn="{{ c }}"
                                            onclick="setConditionFilter('{{ c }}', this)"
                                            class="flex items-center px-3 py-2 rounded-lg text-[11px] font-bold uppercase tracking-wider text-gray-300 hover:bg-white/10 hover:text-white transition-all text-left whitespace-nowrap">
                                            {{ c }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Collection Dropdown -->
                                <div class="relative filter-dropdown" data-filter-group="collection">
                                    <button type="button" onclick="toggleFilterDropdown('collection')"
                                        class="flex items-center gap-1.5 h-9 px-3 rounded-full border border-white/10 bg-white/5 hover:bg-white/10 transition-all cursor-pointer">
                                        <span
                                            class="text-[10px] font-bold uppercase tracking-wider text-gray-300">Collection</span>
                                        <span
                                            class="material-symbols-outlined text-gray-400 text-sm transition-transform"
                                            id="collection-chevron">expand_more</span>
                                        <span id="collection-badge"
                                            class="hidden text-[8px] font-black bg-primary text-background-dark px-1.5 py-0.5 rounded-full uppercase"></span>
                                    </button>
                                    <div id="collection-dropdown-panel"
                                        class="absolute top-full left-0 mt-2 w-auto min-w-[160px] bg-surface border border-white/10 rounded-xl shadow-2xl opacity-0 invisible transition-all duration-200 overflow-hidden z-50 p-2 flex flex-col gap-1">
                                        {% for collection in collections %}
                                        <button type="button" data-collection-btn="{{ collection.handle }}"
                                            onclick="setActiveCollection('{{ collection.handle }}', this)"
                                            class="flex items-center gap-2 px-3 py-2 rounded-lg text-[11px] font-bold uppercase tracking-wider text-gray-300 hover:bg-white/10 hover:text-white transition-all text-left whitespace-nowrap">
                                            {% if collection.image %}
                                            <img src="{{ collection.image }}" class="w-4 h-4 rounded-full" alt="">
                                            {% endif %}
                                            {{ collection.title }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Clear button -->
                            <div class="flex items-center gap-3">
                                <div class="w-px h-5 bg-white/10 shrink-0"></div>
                                <button type="button" onclick="resetFilters()"
                                    class="shrink-0 px-3 py-1.5 text-[10px] font-bold text-gray-400 hover:text-primary hover:bg-white/5 uppercase tracking-wider transition-all rounded-lg border border-transparent hover:border-white/10">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE: Filter Bottom Sheet ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="filter-sheet-backdrop"
            class="md:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] opacity-0 invisible transition-opacity duration-300"
            onclick="closeFilterSheet()">
        </div>
        <div id="filter-sheet"
            class="md:hidden fixed bottom-0 left-0 right-0 z-[70] bg-surface rounded-t-2xl transform translate-y-full transition-transform duration-300 ease-out"
            style="max-height: 75vh;">
            <!-- Drag Handle -->
            <div class="flex justify-center pt-3 pb-2" onclick="closeFilterSheet()">
                <div class="w-10 h-1 bg-white/20 rounded-full"></div>
            </div>
            <!-- Sheet Header -->
            <div class="flex items-center justify-between px-5 pb-3 border-b border-white/10">
                <h3 class="text-sm font-bold text-white uppercase tracking-wider">Filters</h3>
                <button type="button" onclick="closeFilterSheet()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 active:bg-white/10">
                    <span class="material-symbols-outlined text-gray-400 text-lg">close</span>
                </button>
            </div>
            <!-- Sheet Content (scrollable) -->
            <div class="overflow-y-auto px-5 py-4 space-y-5" style="max-height: calc(75vh - 140px);">
                <!-- Price Filter -->
                <div>
                    <h4 class="text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-3">Price Range</h4>
                    <div id="sheet-price-filter" class="px-1">
                        <!-- Price slider will be synced via JS -->
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] text-gray-400">Price Under</span>
                            <span id="sheet-price-display" class="text-[10px] font-black text-primary">¬•30,000+</span>
                        </div>
                        <input type="range" id="sheet-price-slider" min="0" max="30000" value="30000" step="500"
                            oninput="syncPriceFromSheet(this.value)"
                            class="w-full h-1 bg-white/10 rounded-full appearance-none cursor-pointer accent-primary">
                    </div>
                </div>

                <!-- Rarity -->
                <div>
                    <h4 class="text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-3">Rarity</h4>
                    <div class="flex flex-wrap gap-2">
                        {% set rarities = ['Common', 'Uncommon', 'Rare', 'Epic', 'Ultra Rare'] %}
                        {% for r in rarities %}
                        <button type="button" data-sheet-rarity="{{ r }}"
                            onclick="setSheetFilter('rarity', '{{ r }}', this)"
                            class="px-4 py-2.5 rounded-full border border-white/10 bg-white/5 text-[11px] font-bold uppercase tracking-wider text-gray-300 active:scale-95 transition-all">
                            {{ r }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Condition -->
                <div>
                    <h4 class="text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-3">Condition</h4>
                    <div class="flex flex-wrap gap-2">
                        {% set conditions = ['Booster Pack', 'Raw', 'Slab', 'Toploader'] %}
                        {% for c in conditions %}
                        <button type="button" data-sheet-condition="{{ c }}"
                            onclick="setSheetFilter('condition', '{{ c }}', this)"
                            class="px-4 py-2.5 rounded-full border border-white/10 bg-white/5 text-[11px] font-bold uppercase tracking-wider text-gray-300 active:scale-95 transition-all">
                            {{ c }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Collection -->
                <div>
                    <h4 class="text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-3">Collection</h4>
                    <div class="flex flex-wrap gap-2">
                        {% for collection in collections %}
                        <button type="button" data-sheet-collection="{{ collection.handle }}"
                            onclick="setSheetFilter('collection', '{{ collection.handle }}', this)"
                            class="flex items-center gap-2 px-4 py-2.5 rounded-full border border-white/10 bg-white/5 text-[11px] font-bold uppercase tracking-wider text-gray-300 active:scale-95 transition-all">
                            {% if collection.image %}
                            <img src="{{ collection.image }}" class="w-4 h-4 rounded-full" alt="">
                            {% endif %}
                            {{ collection.title }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <!-- Sheet Footer -->
            <div class="px-5 py-4 border-t border-white/10 flex gap-3 safe-area-bottom">
                <button type="button" onclick="resetFiltersFromSheet()"
                    class="flex-1 h-12 rounded-xl border border-white/10 text-[11px] font-bold uppercase tracking-wider text-gray-300 active:bg-white/5 transition-all">
                    Clear All
                </button>
                <button type="button" onclick="applyFiltersFromSheet()"
                    class="flex-1 h-12 rounded-xl bg-primary text-background-dark text-[11px] font-black uppercase tracking-wider active:bg-primary/80 transition-all">
                    Show Results
                </button>
            </div>
        </div>

        <div class="py-6">


            <div id="product-grid"
                class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-x-4 gap-y-8 relative">
                <!-- Loading Overlay -->
                <div id="grid-loading"
                    class="htmx-indicator absolute inset-0 bg-background-dark/80 backdrop-blur-sm z-10 flex items-center justify-center">
                    <div class="flex flex-col items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-4xl animate-spin">sync</span>
                        <p class="text-sm text-gray-400 font-medium">Loading cards...</p>
                    </div>
                </div>
                {% include "partials/product_grid.html" %}
            </div>
        </div>
    </section>

    <!-- ==================== FOOTER ==================== -->
    <footer class="mt-16 border-t border-white/5 pt-12 pb-32 md:pb-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <!-- About -->
            <div>
                <h4 class="text-sm font-bold text-white mb-4">About</h4>
                <p class="text-xs text-gray-400 leading-relaxed">TCGNakama.com is the premier marketplace for trading
                    card enthusiasts and investors.</p>
            </div>
            <!-- Support -->
            <div>
                <h4 class="text-sm font-bold text-white mb-4">Support</h4>
                <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
                    <a href="#" class="text-xs text-gray-400 hover:text-primary transition-colors">Help Center</a>
                    <span class="text-gray-600 text-[10px]">¬∑</span>
                    <a href="#" class="text-xs text-gray-400 hover:text-primary transition-colors">Shipping</a>
                    <span class="text-gray-600 text-[10px]">¬∑</span>
                    <a href="#" class="text-xs text-gray-400 hover:text-primary transition-colors">Returns</a>
                </div>
            </div>
            <!-- Social -->
            <div>
                <h4 class="text-sm font-bold text-white mb-4">Social</h4>
                <div class="flex gap-3">
                    <a href="#"
                        class="w-8 h-8 bg-white/5 rounded-full flex items-center justify-center hover:bg-primary/20 transition-colors">
                        <span class="material-symbols-outlined text-gray-400 text-sm">public</span>
                    </a>
                    <a href="#"
                        class="w-8 h-8 bg-white/5 rounded-full flex items-center justify-center hover:bg-primary/20 transition-colors">
                        <span class="material-symbols-outlined text-gray-400 text-sm">photo_camera</span>
                    </a>
                    <a href="#"
                        class="w-8 h-8 bg-white/5 rounded-full flex items-center justify-center hover:bg-primary/20 transition-colors">
                        <span class="material-symbols-outlined text-gray-400 text-sm">smart_display</span>
                    </a>
                </div>
            </div>
            <!-- Newsletter -->
            <div>
                <h4 class="text-sm font-bold text-white mb-4">Newsletter</h4>
                <div class="flex gap-2">
                    <input type="email" placeholder="Your email"
                        class="flex-1 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-xs text-white placeholder-gray-500 focus:border-primary outline-none">
                    <button
                        class="px-3 py-2 bg-primary text-background-dark text-xs font-bold rounded-lg hover:bg-primary-dark transition-colors">‚Üí</button>
                </div>
            </div>
        </div>
        <!-- Copyright + Merchant Login -->
        <div class="mt-8 pt-6 border-t border-white/5 flex flex-col md:flex-row items-center justify-between gap-2">
            <p class="text-[10px] text-gray-600 font-bold uppercase tracking-[0.3em]">¬© 2026 TCG Nakama</p>
            <a href="/admin/login"
                class="text-[10px] text-gray-600 hover:text-primary font-bold uppercase tracking-[0.3em] transition-colors">
                üîê Merchant Login</a>
        </div>
    </footer>

</main>

<!-- Containers -->
<div id="modal-container"></div>
<div id="cart-drawer-container"></div>

<!-- Scroll to Top -->
<a class="fixed bottom-20 md:bottom-6 right-6 z-[60] w-10 h-10 bg-surface border border-vault-border rounded-full flex items-center justify-center text-primary/60 transition-all hover:text-primary group"
    href="#top">
    <span class="material-symbols-outlined text-xl group-hover:-translate-y-1 transition-transform">arrow_upward</span>
</a>

<!-- ==================== MOBILE BOTTOM NAV ==================== -->
<nav
    class="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-surface/95 backdrop-blur-lg border-t border-white/10 safe-area-bottom">
    <div class="flex items-center justify-around pt-2 pb-1">
        <a href="/" class="flex flex-col items-center gap-0.5 px-3 py-1">
            <span class="material-symbols-outlined text-primary text-xl">home</span>
            <span class="text-[9px] font-bold text-primary">Home</span>
        </a>
        <a href="#" class="flex flex-col items-center gap-0.5 px-3 py-1"
            onclick="document.getElementById('search-input').focus(); window.scrollTo(0,0); return false;">
            <span class="material-symbols-outlined text-gray-500 text-xl">search</span>
            <span class="text-[9px] font-bold text-gray-500">Search</span>
        </a>
        <a href="#all-cards-section" class="flex flex-col items-center gap-0.5 px-3 py-1">
            <span class="material-symbols-outlined text-gray-500 text-xl">storefront</span>
            <span class="text-[9px] font-bold text-gray-500">Shop</span>
        </a>
        <a href="#" class="flex flex-col items-center gap-0.5 px-3 py-1"
            onclick="event.preventDefault(); openCollectionSheet()">
            <span class="material-symbols-outlined text-gray-500 text-xl">grid_view</span>
            <span class="text-[9px] font-bold text-gray-500">Collection</span>
        </a>
        <button class="relative flex flex-col items-center gap-0.5 px-3 py-1" hx-get="/cart/drawer"
            hx-target="#cart-drawer-container">
            <span class="material-symbols-outlined text-gray-500 text-xl">shopping_cart</span>
            <span class="text-[9px] font-bold text-gray-500">Cart</span>
            <span id="cart-count-mobile"
                class="absolute top-0 right-1 w-4 h-4 bg-neon-red text-[8px] font-black text-white rounded-full flex items-center justify-center">{{
                cart_count }}</span>
        </button>
    </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE: Collection Bottom Sheet ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="collection-sheet-backdrop"
    class="md:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] opacity-0 invisible transition-opacity duration-300"
    onclick="closeCollectionSheet()"></div>
<div id="collection-sheet"
    class="md:hidden fixed bottom-0 left-0 right-0 z-[70] bg-surface rounded-t-2xl transform translate-y-full transition-transform duration-300 ease-out">
    <div class="flex justify-center pt-3 pb-2" onclick="closeCollectionSheet()">
        <div class="w-10 h-1 bg-white/20 rounded-full"></div>
    </div>
    <div class="flex items-center justify-between px-5 pb-3 border-b border-white/10">
        <h3 class="text-sm font-bold text-white uppercase tracking-wider">Collections</h3>
        <button type="button" onclick="closeCollectionSheet()"
            class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 active:bg-white/10">
            <span class="material-symbols-outlined text-gray-400 text-lg">close</span>
        </button>
    </div>
    <div class="px-5 py-4 space-y-1 safe-area-bottom">
        {% for collection in collections %}
        <button type="button" onclick="pickCollection('{{ collection.handle }}')"
            class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl active:bg-white/5 transition-all text-left">
            {% if collection.image %}
            <img src="{{ collection.image }}" class="w-6 h-6 rounded-full" alt="">
            {% endif %}
            <span class="text-sm font-bold text-white">{{ collection.title }}</span>
        </button>
        {% endfor %}
    </div>
</div>

<!-- Scripts -->
<script>
    function updatePriceDisplay(val) {
        const display = document.getElementById('price-display');
        if (display) display.textContent = `¬•${parseInt(val).toLocaleString()}`;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Resync Shopify Products ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function resyncShopifyProducts() {
        const btn = document.getElementById('resync-btn');
        const icon = document.getElementById('resync-icon');

        // Disable button and show loading state
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        icon.classList.add('animate-spin');

        // Trigger HTMX refresh
        if (typeof htmx !== 'undefined') {
            htmx.ajax('POST', '/refresh', {
                target: '#product-grid',
                swap: 'outerHTML'
            }).then(() => {
                // Re-enable button after sync
                setTimeout(() => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    icon.classList.remove('animate-spin');
                }, 1000);
            }).catch(() => {
                // Re-enable button on error
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                icon.classList.remove('animate-spin');
                alert('Failed to sync products. Please try again.');
            });
        }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Dynamic Sticky Offset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateFilterStickyOffset() {
        const header = document.querySelector('header');
        const filterBar = document.getElementById('filter-sticky-bar');
        if (header && filterBar) {
            filterBar.style.top = header.offsetHeight + 'px';
        }
    }
    updateFilterStickyOffset();
    window.addEventListener('resize', updateFilterStickyOffset);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Filter Dropdown Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleFilterDropdown(group) {
        const panel = document.getElementById(`${group}-dropdown-panel`);
        const chevron = document.getElementById(`${group}-chevron`);
        if (!panel) return;

        const isOpen = panel.classList.contains('opacity-100');

        // Close all dropdowns first
        document.querySelectorAll('.filter-dropdown [id$="-dropdown-panel"]').forEach(p => {
            p.classList.remove('opacity-100', 'visible');
            p.classList.add('opacity-0', 'invisible');
        });
        document.querySelectorAll('.filter-dropdown [id$="-chevron"]').forEach(c => {
            c.classList.remove('rotate-180');
        });

        // Toggle current dropdown
        if (!isOpen) {
            panel.classList.remove('opacity-0', 'invisible');
            panel.classList.add('opacity-100', 'visible');
            if (chevron) chevron.classList.add('rotate-180');
        }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-dropdown')) {
            document.querySelectorAll('.filter-dropdown [id$="-dropdown-panel"]').forEach(p => {
                p.classList.remove('opacity-100', 'visible');
                p.classList.add('opacity-0', 'invisible');
            });
            document.querySelectorAll('.filter-dropdown [id$="-chevron"]').forEach(c => {
                c.classList.remove('rotate-180');
            });
        }
    });

    function updateFilterBadge(group, value) {
        const badge = document.getElementById(`${group}-badge`);
        if (!badge) return;

        if (value) {
            badge.textContent = value;
            badge.classList.remove('hidden');
        } else {
            badge.textContent = '';
            badge.classList.add('hidden');
        }
    }

    function setActiveFilter(rarity, el) {
        const input = document.getElementById('rarity-input');
        const current = input.value;
        const activeClasses = ['bg-primary', 'border-primary', 'shadow-[0_0_20px_rgba(244,37,209,0.5)]', 'text-white'];
        const inactiveClasses = ['bg-white/5', 'border-white/10', 'hover:bg-white/10', 'text-gray-300'];

        if (current === rarity) {
            input.value = '';
            el.classList.remove(...activeClasses);
            el.classList.add(...inactiveClasses);
            updateFilterBadge('rarity', '');
        } else {
            document.querySelectorAll('[data-rarity-btn]').forEach(b => {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
            });
            input.value = rarity;
            el.classList.add(...activeClasses);
            el.classList.remove(...inactiveClasses);
            updateFilterBadge('rarity', rarity);
        }

        if (typeof htmx !== 'undefined') {
            htmx.trigger(input, 'change');
        }
        input.dispatchEvent(new Event('change'));
    }

    function setActiveCollection(handle, el) {
        const input = document.getElementById('collection-input');
        const current = input.value;
        const activeClasses = ['bg-primary', 'border-primary', 'shadow-[0_0_20px_rgba(244,37,209,0.5)]', 'text-white'];
        const inactiveClasses = ['bg-white/5', 'border-white/10', 'hover:bg-white/10', 'text-gray-300'];

        if (current === handle) {
            input.value = '';
            el.classList.remove(...activeClasses);
            el.classList.add(...inactiveClasses);
            updateFilterBadge('collection', '');
        } else {
            document.querySelectorAll('[data-collection-btn]').forEach(b => {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
            });
            input.value = handle;
            el.classList.add(...activeClasses);
            el.classList.remove(...inactiveClasses);
            // Get collection title for badge
            const collectionTitle = el.textContent.trim();
            updateFilterBadge('collection', collectionTitle);
        }

        if (typeof htmx !== 'undefined') {
            htmx.trigger(input, 'change');
        }
        input.dispatchEvent(new Event('change'));
    }

    function shopCollection(handle) {
        // Find the matching collection filter button and click it
        const btn = document.querySelector(`[data-collection-btn="${handle}"]`);
        if (btn) {
            setActiveCollection(handle, btn);
        } else {
            // Fallback: set the input directly if filter button hasn't loaded yet
            const input = document.getElementById('collection-input');
            if (input) {
                input.value = handle;
                if (typeof htmx !== 'undefined') {
                    htmx.trigger(input, 'change');
                }
                input.dispatchEvent(new Event('change'));
            }
        }
        // Smooth scroll to All Cards section
        const section = document.getElementById('all-cards-section');
        if (section) {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function clearFilterVisuals() {
        const activeClasses = ['bg-primary', 'border-primary', 'shadow-[0_0_20px_rgba(244,37,209,0.5)]', 'text-white'];
        const inactiveClasses = ['bg-white/5', 'border-white/10', 'hover:bg-white/10', 'text-gray-300'];

        document.querySelectorAll('[data-rarity-btn], [data-collection-btn], [data-condition-btn]').forEach(b => {
            b.classList.remove(...activeClasses);
            b.classList.add(...inactiveClasses);
        });

        const rarityInput = document.getElementById('rarity-input');
        const collectionInput = document.getElementById('collection-input');
        const conditionInput = document.getElementById('condition-input');
        if (rarityInput) rarityInput.value = '';
        if (collectionInput) collectionInput.value = '';
        if (conditionInput) conditionInput.value = '';

        // Clear badges
        updateFilterBadge('rarity', '');
        updateFilterBadge('condition', '');
        updateFilterBadge('collection', '');
    }

    function setConditionFilter(condition, element) {
        const conditionInput = document.getElementById('condition-input');
        if (!conditionInput) return;

        const activeClasses = ['bg-primary', 'border-primary', 'shadow-[0_0_20px_rgba(244,37,209,0.5)]', 'text-white'];
        const inactiveClasses = ['bg-white/5', 'border-white/10', 'hover:bg-white/10', 'text-gray-300'];

        // Toggle: if clicking the same condition, clear it
        if (conditionInput.value === condition) {
            conditionInput.value = '';
            element.classList.remove(...activeClasses);
            element.classList.add(...inactiveClasses);
            updateFilterBadge('condition', '');
        } else {
            // Clear other condition buttons
            document.querySelectorAll('[data-condition-btn]').forEach(b => {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
            });
            conditionInput.value = condition;
            element.classList.add(...activeClasses);
            element.classList.remove(...inactiveClasses);
            updateFilterBadge('condition', condition);
        }

        // Trigger HTMX update
        if (typeof htmx !== 'undefined') {
            htmx.trigger(conditionInput, 'change');
        } else {
            conditionInput.dispatchEvent(new Event('change'));
        }
    }

    function resetFilters() {
        const searchInput = document.getElementById('search-input');
        const rarityInput = document.getElementById('rarity-input');
        const collectionInput = document.getElementById('collection-input');
        const conditionInput = document.getElementById('condition-input');
        const priceSlider = document.getElementById('price-slider');
        const mainPriceSlider = document.getElementById('main-price-slider');

        if (searchInput) searchInput.value = '';
        if (rarityInput) rarityInput.value = '';
        if (collectionInput) collectionInput.value = '';
        if (conditionInput) conditionInput.value = '';
        if (priceSlider) priceSlider.value = '';
        if (mainPriceSlider) {
            mainPriceSlider.value = 30000;
            const display = document.getElementById('price-display');
            if (display) display.textContent = "¬•30,000+";
        }

        clearFilterVisuals();

        // Clear all badges
        updateFilterBadge('rarity', '');
        updateFilterBadge('condition', '');
        updateFilterBadge('collection', '');

        // Sync mobile sheet visuals
        syncSheetVisuals();
        updateMobileFilterCount();

        // Trigger update
        if (rarityInput) {
            if (typeof htmx !== 'undefined') {
                htmx.trigger(rarityInput, 'change');
            } else {
                rarityInput.dispatchEvent(new Event('change'));
            }
        }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Mobile Filter Bottom Sheet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openFilterSheet() {
        const backdrop = document.getElementById('filter-sheet-backdrop');
        const sheet = document.getElementById('filter-sheet');
        if (!backdrop || !sheet) return;

        // Sync sheet state with current hidden inputs
        syncSheetVisuals();

        backdrop.classList.remove('opacity-0', 'invisible');
        backdrop.classList.add('opacity-100');
        sheet.classList.remove('translate-y-full');
        sheet.classList.add('translate-y-0');
        document.body.style.overflow = 'hidden';
    }

    function closeFilterSheet() {
        const backdrop = document.getElementById('filter-sheet-backdrop');
        const sheet = document.getElementById('filter-sheet');
        if (!backdrop || !sheet) return;

        backdrop.classList.add('opacity-0', 'invisible');
        backdrop.classList.remove('opacity-100');
        sheet.classList.add('translate-y-full');
        sheet.classList.remove('translate-y-0');
        document.body.style.overflow = '';
    }

    function setSheetFilter(group, value, el) {
        const input = document.getElementById(`${group}-input`);
        if (!input) return;

        const activeClasses = ['bg-primary', 'border-primary', 'text-white'];
        const inactiveClasses = ['bg-white/5', 'border-white/10', 'text-gray-300'];
        const btnAttr = `data-sheet-${group}`;

        if (input.value === value) {
            // Deselect
            input.value = '';
            el.classList.remove(...activeClasses);
            el.classList.add(...inactiveClasses);
        } else {
            // Deselect all in this group first
            document.querySelectorAll(`[${btnAttr}]`).forEach(b => {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
            });
            // Select this one
            input.value = value;
            el.classList.add(...activeClasses);
            el.classList.remove(...inactiveClasses);
        }

        // Also sync desktop dropdown visuals
        syncDesktopFilterVisual(group, input.value);
        updateMobileFilterCount();
    }

    function syncDesktopFilterVisual(group, value) {
        const activeClasses = ['bg-primary', 'border-primary', 'shadow-[0_0_20px_rgba(244,37,209,0.5)]', 'text-white'];
        const inactiveClasses = ['bg-white/5', 'border-white/10', 'hover:bg-white/10', 'text-gray-300'];

        document.querySelectorAll(`[data-${group}-btn]`).forEach(b => {
            const btnVal = b.getAttribute(`data-${group}-btn`);
            if (btnVal === value) {
                b.classList.add(...activeClasses);
                b.classList.remove(...inactiveClasses);
            } else {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
            }
        });

        updateFilterBadge(group, value);
    }

    function syncPriceFromSheet(val) {
        const priceSlider = document.getElementById('price-slider');
        const mainSlider = document.getElementById('main-price-slider');
        const sheetDisplay = document.getElementById('sheet-price-display');
        const mainDisplay = document.getElementById('price-display');

        if (priceSlider) priceSlider.value = val;
        if (mainSlider) mainSlider.value = val;

        const displayText = parseInt(val) >= 30000 ? '¬•30,000+' : `¬•${parseInt(val).toLocaleString()}`;
        if (sheetDisplay) sheetDisplay.textContent = displayText;
        if (mainDisplay) mainDisplay.textContent = displayText;

        updateMobileFilterCount();
    }

    function syncSheetVisuals() {
        const activeClasses = ['bg-primary', 'border-primary', 'text-white'];
        const inactiveClasses = ['bg-white/5', 'border-white/10', 'text-gray-300'];

        // Sync rarity
        const rarityVal = document.getElementById('rarity-input')?.value || '';
        document.querySelectorAll('[data-sheet-rarity]').forEach(b => {
            if (b.getAttribute('data-sheet-rarity') === rarityVal && rarityVal) {
                b.classList.add(...activeClasses);
                b.classList.remove(...inactiveClasses);
            } else {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
            }
        });

        // Sync condition
        const conditionVal = document.getElementById('condition-input')?.value || '';
        document.querySelectorAll('[data-sheet-condition]').forEach(b => {
            if (b.getAttribute('data-sheet-condition') === conditionVal && conditionVal) {
                b.classList.add(...activeClasses);
                b.classList.remove(...inactiveClasses);
            } else {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
            }
        });

        // Sync collection
        const collectionVal = document.getElementById('collection-input')?.value || '';
        document.querySelectorAll('[data-sheet-collection]').forEach(b => {
            if (b.getAttribute('data-sheet-collection') === collectionVal && collectionVal) {
                b.classList.add(...activeClasses);
                b.classList.remove(...inactiveClasses);
            } else {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
            }
        });

        // Sync price slider
        const priceVal = document.getElementById('price-slider')?.value || '30000';
        const sheetSlider = document.getElementById('sheet-price-slider');
        const sheetDisplay = document.getElementById('sheet-price-display');
        if (sheetSlider) sheetSlider.value = priceVal || 30000;
        if (sheetDisplay) {
            const v = parseInt(priceVal || 30000);
            sheetDisplay.textContent = v >= 30000 ? '¬•30,000+' : `¬•${v.toLocaleString()}`;
        }
    }

    function resetFiltersFromSheet() {
        // Clear all hidden inputs
        const rarityInput = document.getElementById('rarity-input');
        const collectionInput = document.getElementById('collection-input');
        const conditionInput = document.getElementById('condition-input');
        const priceSlider = document.getElementById('price-slider');

        if (rarityInput) rarityInput.value = '';
        if (collectionInput) collectionInput.value = '';
        if (conditionInput) conditionInput.value = '';
        if (priceSlider) priceSlider.value = '';

        // Reset main price slider
        const mainSlider = document.getElementById('main-price-slider');
        if (mainSlider) mainSlider.value = 30000;
        const mainDisplay = document.getElementById('price-display');
        if (mainDisplay) mainDisplay.textContent = '¬•30,000+';

        // Clear desktop visuals
        clearFilterVisuals();
        updateFilterBadge('rarity', '');
        updateFilterBadge('condition', '');
        updateFilterBadge('collection', '');

        // Sync and update sheet visuals
        syncSheetVisuals();
        updateMobileFilterCount();
    }

    function applyFiltersFromSheet() {
        // Trigger HTMX update using hidden inputs
        const rarityInput = document.getElementById('rarity-input');
        if (rarityInput && typeof htmx !== 'undefined') {
            htmx.trigger(rarityInput, 'change');
        }

        closeFilterSheet();

        // Scroll to product grid
        const section = document.getElementById('all-cards-section');
        if (section) {
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 350);
        }
    }

    function updateMobileFilterCount() {
        const count = [
            document.getElementById('rarity-input')?.value,
            document.getElementById('condition-input')?.value,
            document.getElementById('collection-input')?.value,
            (document.getElementById('price-slider')?.value && parseInt(document.getElementById('price-slider')?.value) < 30000) ? 'price' : ''
        ].filter(Boolean).length;

        const badge = document.getElementById('mobile-filter-count');
        const clearBtn = document.getElementById('mobile-clear-btn');

        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        if (clearBtn) {
            if (count > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Mobile Collection Sheet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openCollectionSheet() {
        const backdrop = document.getElementById('collection-sheet-backdrop');
        const sheet = document.getElementById('collection-sheet');
        if (!backdrop || !sheet) return;
        backdrop.classList.remove('opacity-0', 'invisible');
        backdrop.classList.add('opacity-100');
        sheet.classList.remove('translate-y-full');
        sheet.classList.add('translate-y-0');
        document.body.style.overflow = 'hidden';
    }

    function closeCollectionSheet() {
        const backdrop = document.getElementById('collection-sheet-backdrop');
        const sheet = document.getElementById('collection-sheet');
        if (!backdrop || !sheet) return;
        backdrop.classList.add('opacity-0', 'invisible');
        backdrop.classList.remove('opacity-100');
        sheet.classList.add('translate-y-full');
        sheet.classList.remove('translate-y-0');
        document.body.style.overflow = '';
    }

    function pickCollection(handle) {
        closeCollectionSheet();
        setTimeout(() => {
            shopCollection(handle);
        }, 300);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Hero Banner Carousel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const _C = { idx: 0, total: document.querySelectorAll('.carousel-dot').length, timer: null };

    function _carouselUpdate() {
        const track = document.getElementById('carousel-track');
        if (!track) return;
        track.style.transform = `translateX(-${_C.idx * (100 / _C.total)}%)`;
        document.querySelectorAll('.carousel-dot').forEach(d => {
            const i = parseInt(d.dataset.index);
            d.classList.toggle('bg-primary', i === _C.idx);
            d.classList.toggle('w-6', i === _C.idx);
            d.classList.toggle('bg-white/40', i !== _C.idx);
            d.classList.toggle('w-2', i !== _C.idx);
        });
    }

    function carouselNext() { _C.idx = (_C.idx + 1) % _C.total; _carouselUpdate(); _carouselResetTimer(); }
    function carouselPrev() { _C.idx = (_C.idx - 1 + _C.total) % _C.total; _carouselUpdate(); _carouselResetTimer(); }
    function carouselGoto(i) { _C.idx = i; _carouselUpdate(); _carouselResetTimer(); }

    function _carouselResetTimer() {
        clearInterval(_C.timer);
        _C.timer = setInterval(carouselNext, 5000);
    }

    // Auto-advance every 5s
    _C.timer = setInterval(carouselNext, 5000);

    // Touch / swipe support
    (function () {
        const el = document.getElementById('hero-carousel');
        if (!el) return;
        let startX = 0;
        el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, { passive: true });
        el.addEventListener('touchend', e => {
            const diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) { diff > 0 ? carouselNext() : carouselPrev(); }
        }, { passive: true });
    })();
</script>

{% endblock %}